<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foursquare Licensing Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    .screen { display: none; }
    .screen.active { display: block; }
    .lesson-content { line-height: 1.8; }
    .lesson-content p { margin-bottom: 1rem; }
    .scripture { background: #fef3c7; padding: 1rem; border-left: 4px solid #f59e0b; margin: 1rem 0; border-radius: 0 0.5rem 0.5rem 0; }
    .quiz-option { transition: all 0.2s; cursor: pointer; }
    .quiz-option:hover:not(:disabled) { transform: translateX(4px); }
    .quiz-option.selected { border-color: #3b82f6 !important; background: #eff6ff !important; }
    .quiz-option.correct { border-color: #10b981 !important; background: #d1fae5 !important; }
    .quiz-option.incorrect { border-color: #ef4444 !important; background: #fee2e2 !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <!-- LOGIN SCREEN -->
  <div id="screen-login" class="screen active">
    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-8">
        <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>
          </div>
          <h1 class="text-2xl font-bold text-slate-800">Foursquare Licensing Tracker</h1>
          <p class="text-slate-500 mt-2">Study & prepare for your licensing interview</p>
        </div>

        <div id="login-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
            <input type="email" id="login-email" class="w-full border rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
            <input type="password" id="login-password" class="w-full border rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button id="btn-login" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-medium hover:opacity-90">Sign In</button>
          <p class="text-center text-sm text-slate-500 mt-4">Don't have an account? <span id="link-register" class="text-blue-600 hover:underline cursor-pointer">Create one</span></p>
        </div>

        <div id="register-form" style="display:none;">
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
            <input type="text" id="reg-name" class="w-full border rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Smith">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
            <input type="email" id="reg-email" class="w-full border rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com">
          </div>
          <div class="mb-6">
            <label class="block text-sm font-medium text-slate-700 mb-1">Password (min 6 characters)</label>
            <input type="password" id="reg-password" class="w-full border rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button id="btn-register" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-medium hover:opacity-90">Create Account</button>
          <p class="text-center text-sm text-slate-500 mt-4">Already have an account? <span id="link-login" class="text-blue-600 hover:underline cursor-pointer">Sign in</span></p>
        </div>

        <div id="login-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
        <div id="login-loading" class="hidden mt-4 text-center text-slate-500">
          <div class="inline-block w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mr-2"></div>
          Loading...
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="screen-app" class="screen">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white shadow-lg">
      <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>
          </div>
          <div>
            <h1 class="text-lg font-bold">Foursquare Licensing Tracker</h1>
            <p class="text-blue-200 text-sm" id="user-greeting">Welcome!</p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <span id="save-status" class="text-xs text-green-300 hidden">‚úì Saved</span>
          <button id="btn-logout" class="text-blue-200 hover:text-white text-sm">Sign Out</button>
        </div>
      </div>
    </header>
    <main class="max-w-6xl mx-auto px-4 py-6">
      <div class="bg-white rounded-xl shadow-sm border p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800">Your Learning Journey</h2>
            <p class="text-sm text-slate-500">‚òÅÔ∏è Progress saved to cloud</p>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-blue-600" id="overall-progress">0%</div>
            <div class="text-sm text-slate-500">Complete</div>
          </div>
        </div>
        <div class="w-full bg-slate-100 rounded-full h-3 mb-4">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all" id="progress-bar" style="width:0%"></div>
        </div>
        <p class="text-slate-600 text-sm">Complete all 5 domains. Study lessons, then pass each quiz (80%+) to advance.</p>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="domain-cards"></div>
    </main>
  </div>

  <!-- LESSON SCREEN -->
  <div id="screen-lesson" class="screen">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white shadow-lg">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <button id="lesson-back" class="flex items-center gap-2 text-blue-200 hover:text-white">‚Üê Back</button>
        <div class="text-center">
          <div class="text-sm text-blue-200" id="lesson-domain-label"></div>
          <div class="font-bold" id="lesson-title"></div>
        </div>
        <div class="text-sm text-blue-200" id="lesson-progress"></div>
      </div>
    </header>
    <main class="max-w-4xl mx-auto px-4 py-6">
      <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8">
        <div id="lesson-content" class="lesson-content text-slate-700"></div>
        <div class="mt-8 pt-6 border-t flex justify-between">
          <button id="btn-prev" class="px-6 py-3 border rounded-lg text-slate-600 hover:bg-slate-50 hidden">‚Üê Previous</button>
          <button id="btn-next" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-auto">Continue ‚Üí</button>
        </div>
      </div>
    </main>
  </div>

  <!-- QUIZ SCREEN -->
  <div id="screen-quiz" class="screen">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white shadow-lg">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <button id="quiz-back" class="flex items-center gap-2 text-blue-200 hover:text-white">‚Üê Exit</button>
        <div class="text-center">
          <div class="text-sm text-blue-200" id="quiz-domain-label"></div>
          <div class="font-bold">Knowledge Check</div>
        </div>
        <div class="text-sm text-blue-200" id="quiz-progress"></div>
      </div>
    </header>
    <main class="max-w-4xl mx-auto px-4 py-6">
      <div class="bg-white rounded-xl shadow-sm border p-6 md:p-8">
        <div id="quiz-question" class="text-xl font-medium text-slate-800 mb-6"></div>
        <div id="quiz-options" class="space-y-3"></div>
        <div id="quiz-feedback" class="hidden mt-6 p-4 rounded-lg"></div>
        <div class="mt-8 pt-6 border-t flex justify-end">
          <button id="btn-submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>Check Answer</button>
          <button id="btn-next-q" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">Next ‚Üí</button>
        </div>
      </div>
    </main>
  </div>

  <!-- RESULTS SCREEN -->
  <div id="screen-results" class="screen">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white shadow-lg">
      <div class="max-w-4xl mx-auto px-4 py-4 text-center"><h1 class="text-xl font-bold">Quiz Complete!</h1></div>
    </header>
    <main class="max-w-4xl mx-auto px-4 py-6">
      <div class="bg-white rounded-xl shadow-sm border p-8 text-center">
        <div id="results-icon" class="text-6xl mb-4">üéâ</div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2" id="results-title">Great Job!</h2>
        <p class="text-slate-600 mb-6" id="results-message"></p>
        <div class="flex justify-center gap-4 mb-8">
          <div class="bg-green-50 rounded-xl p-4"><div class="text-3xl font-bold text-green-600" id="results-correct">0</div><div class="text-sm text-green-700">Correct</div></div>
          <div class="bg-red-50 rounded-xl p-4"><div class="text-3xl font-bold text-red-600" id="results-incorrect">0</div><div class="text-sm text-red-700">Incorrect</div></div>
          <div class="bg-blue-50 rounded-xl p-4"><div class="text-3xl font-bold text-blue-600" id="results-percent">0%</div><div class="text-sm text-blue-700">Score</div></div>
        </div>
        <div class="flex justify-center gap-4">
          <button id="btn-retake" class="px-6 py-3 border rounded-lg text-slate-600 hover:bg-slate-50">Retake Quiz</button>
          <button id="btn-continue" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Continue</button>
        </div>
      </div>
    </main>
  </div>

<script>
// SIMPLE TOGGLE - THIS RUNS IMMEDIATELY
(function() {
  var linkReg = document.getElementById('link-register');
  var linkLog = document.getElementById('link-login');
  var formLogin = document.getElementById('login-form');
  var formReg = document.getElementById('register-form');

  if (linkReg) {
    linkReg.onclick = function() {
      formLogin.style.display = 'none';
      formReg.style.display = 'block';
    };
  }

  if (linkLog) {
    linkLog.onclick = function() {
      formReg.style.display = 'none';
      formLogin.style.display = 'block';
    };
  }
})();

// Load Supabase dynamically
var supabase = null;
var SUPABASE_URL = 'https://mvuvgecqxwuqfshqbtjf.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12dXZnZWNxeHd1cWZzaHFidGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwODQ4MTUsImV4cCI6MjA4MzY2MDgxNX0.6OezNuwN5Ip2a_Xw_SsuxoB80nn3WP7D5dnhAEE9A9o';

function initSupabase() {
  if (window.supabase && window.supabase.createClient) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase ready!');
    checkExistingSession();
  } else {
    console.error('Supabase not available');
  }
}

// Load script
var script = document.createElement('script');
script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js';
script.onload = initSupabase;
script.onerror = function() { console.error('Failed to load Supabase'); };
document.head.appendChild(script);

// COURSE DATA
var DOMAINS = [
  {
    id: 'heritage', name: 'Heritage', icon: 'üìú', color: 'from-amber-500 to-orange-600',
    description: 'Learn about Foursquare history and Aimee Semple McPherson.',
    lessons: [
      { title: 'The Founder: Aimee Semple McPherson', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Aimee Semple McPherson (1890-1944)</h3><p>Aimee Elizabeth Kennedy was born on October 9, 1890, in Ontario, Canada. At age 17, she attended a revival led by Robert Semple. After three days of spiritual wrestling, Aimee accepted Christ. She married Robert and they went to China as missionaries.</p><p><strong>Tragedy and Triumph:</strong> Robert died of malaria in China, leaving Aimee pregnant and alone. Despite this loss, she felt God\'s call to preach and began traveling across America, holding tent revivals that drew massive crowds - sometimes over 30,000 people.</p><div class="scripture"><strong>Key Point:</strong> Sister Aimee\'s life exemplified God\'s miraculous mercy - turning tragedy into triumph.</div>' },
      { title: 'The Founding of Angelus Temple', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Building a House Unto the Lord</h3><p>In 1918, Aimee felt God leading her to Los Angeles to "build a house unto the Lord." Not wanting to incur debt, she raised funds "by faith," beginning with just $5,000.</p><p><strong>January 1, 1923:</strong> Angelus Temple was dedicated in Echo Park, Los Angeles. The 5,300-seat auditorium was filled three times daily, seven days a week.</p><div class="scripture"><strong>Historic Fact:</strong> Angelus Temple is considered the first megachurch in the United States. Its 125-foot dome was the largest in North America. The temple received 40 million visitors in its first seven years.</div><p>Eight thousand converts knelt at the altars in the first six months, and 1,500 were baptized.</p>' },
      { title: 'The Foursquare Gospel Vision', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">The Vision That Named a Movement</h3><p>In October 1922, while preaching in Oakland, California, Aimee received a vision based on Ezekiel chapter 1.</p><p><strong>The Foursquare Gospel represents Jesus Christ as:</strong></p><ul class="list-disc pl-6 mb-4 space-y-2"><li><strong>Savior</strong> - Jesus saves us from sin</li><li><strong>Baptizer with the Holy Spirit</strong> - Jesus fills us with power</li><li><strong>Healer</strong> - Jesus heals our bodies and souls</li><li><strong>Soon-Coming King</strong> - Jesus will return again</li></ul><div class="scripture"><strong>Ezekiel 1:10:</strong> "Each had the face of a man; each of the four had the face of a lion on the right side, the face of an ox on the left side, and the face of an eagle."</div>' },
      { title: 'Pioneer in Media Ministry', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">First Woman to Preach on Radio</h3><p>Aimee Semple McPherson pioneered using media for ministry.</p><p><strong>KFSG Radio Station:</strong> In February 1924, Aimee founded KFSG (Kall FourSquare Gospel), making her the first woman to preach on radio.</p><div class="scripture"><strong>Historic Impact:</strong> In her time, Aimee was the most publicized Protestant evangelist in America.</div>' },
      { title: 'Compassion in Action', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Feeding 1.5 Million During the Great Depression</h3><p>In 1927, Aimee opened a commissary at Angelus Temple offering food, clothing, and blankets.</p><p>During the Great Depression, Sister Aimee fed an estimated <strong>1.5 million people</strong>.</p><div class="scripture"><strong>Legacy:</strong> Aimee passed away September 27, 1944. Today, Foursquare has millions of members in over 150 countries.</div>' }
    ],
    quizzes: [
      { question: "In what year was Angelus Temple dedicated?", options: ["1918", "1923", "1927", "1932"], correct: 1, explanation: "Angelus Temple was dedicated on January 1, 1923." },
      { question: "What does the 'Foursquare Gospel' represent?", options: ["Four books of the Bible", "Four founding churches", "Jesus as Savior, Baptizer, Healer, and Coming King", "Four steps to salvation"], correct: 2, explanation: "The Foursquare Gospel represents Christ's fourfold ministry." },
      { question: "Where did Aimee receive the Foursquare vision?", options: ["Los Angeles", "Canada", "Oakland, California", "China"], correct: 2, explanation: "Aimee received the vision while preaching in Oakland in October 1922." },
      { question: "What was the name of Foursquare's radio station?", options: ["KFSG", "WFSG", "KFOUR", "WGOD"], correct: 0, explanation: "KFSG (Kall FourSquare Gospel) was founded in February 1924." },
      { question: "How many people did Angelus Temple feed during the Great Depression?", options: ["100,000", "500,000", "1.5 million", "5 million"], correct: 2, explanation: "Angelus Temple fed an estimated 1.5 million people." }
    ]
  },
  {
    id: 'identity', name: 'Identity', icon: 'üéØ', color: 'from-blue-500 to-indigo-600',
    description: 'Understand Foursquare distinctives and global mission.',
    lessons: [
      { title: 'The Four Corners of Our Gospel', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Jesus Christ: The Same Yesterday, Today, and Forever</h3><p><strong>1. Jesus Christ the Savior</strong> - Jesus saves us from sin.</p><p><strong>2. Jesus Christ the Baptizer with the Holy Spirit</strong> - Jesus fills believers with power.</p><p><strong>3. Jesus Christ the Healer</strong> - Jesus heals in answer to prayer.</p><p><strong>4. Jesus Christ the Soon-Coming King</strong> - Jesus will return.</p><div class="scripture"><strong>Hebrews 13:8:</strong> "Jesus Christ is the same yesterday, today, and forever."</div>' },
      { title: 'Our Mission and Values', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Foursquare\'s Mission</h3><p>Glorify God by proclaiming the Gospel and making disciples.</p><p><strong>Core Values:</strong> Spirit Empowerment, Kingdom Partnership, Healthy Multiplication, Sound Doctrine.</p><div class="scripture"><strong>Matthew 28:19-20:</strong> "Go therefore and make disciples of all the nations."</div>' },
      { title: 'Women in Ministry Leadership', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">A Founding Distinctive</h3><p>Foursquare has always affirmed women in ministry leadership.</p><div class="scripture"><strong>Acts 2:17:</strong> "Your sons AND your daughters shall prophesy."</div>' },
      { title: 'A Global Family', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">From Echo Park to Every Nation</h3><p>Over 90,000 churches in 150+ nations.</p><div class="scripture"><strong>Revelation 7:9:</strong> "A great multitude of all nations, tribes, peoples, and tongues."</div>' }
    ],
    quizzes: [
      { question: "Which is NOT one of the four aspects?", options: ["Jesus the Savior", "Jesus the Teacher", "Jesus the Healer", "Jesus the Coming King"], correct: 1, explanation: "The four are: Savior, Baptizer, Healer, Coming King." },
      { question: "Foursquare's position on women in ministry?", options: ["Support roles only", "Affirmed in all leadership", "Local decision", "Children's ministry only"], correct: 1, explanation: "Foursquare affirms women in all ministry leadership." },
      { question: "How many countries is Foursquare in?", options: ["50", "100", "150+", "200+"], correct: 2, explanation: "Foursquare is in more than 150 nations." },
      { question: "Verse behind Angelus Temple pulpit?", options: ["John 3:16", "Hebrews 13:8", "Matthew 28:19", "Acts 1:8"], correct: 1, explanation: "Hebrews 13:8." },
      { question: "School Aimee founded?", options: ["Fuller Seminary", "L.I.F.E. Bible College", "Angelus Academy", "Foursquare University"], correct: 1, explanation: "L.I.F.E. Bible College." }
    ]
  },
  {
    id: 'doctrine', name: 'Doctrine', icon: 'üìñ', color: 'from-purple-500 to-violet-600',
    description: 'Study the Declaration of Faith.',
    lessons: [
      { title: 'The Holy Scriptures', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Article I</h3><p>The Holy Bible is the Word of God - true, immutable, unchangeable.</p><div class="scripture"><strong>2 Timothy 3:16:</strong> "All Scripture is given by inspiration of God."</div>' },
      { title: 'The Eternal Godhead', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Article II: The Trinity</h3><p>One God in three persons: Father, Son, Holy Spirit.</p><div class="scripture"><strong>1 John 5:7:</strong> "The Father, the Word, and the Holy Spirit; these three are one."</div>' },
      { title: 'Salvation Through Grace', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Salvation</h3><p>By grace through faith, not works.</p><div class="scripture"><strong>Ephesians 2:8-9:</strong> "By grace you have been saved through faith... not of works."</div>' },
      { title: 'The Baptism of the Holy Spirit', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Article X</h3><p>The Spirit baptism endues with power from on high.</p><div class="scripture"><strong>Acts 1:8:</strong> "You shall receive power when the Holy Spirit has come upon you."</div>' },
      { title: 'Divine Healing and Second Coming', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Articles XIV-XV</h3><p>Christ heals in answer to prayer. His return is personal and imminent.</p><div class="scripture"><strong>1 Thessalonians 4:16:</strong> "The Lord Himself will descend from heaven."</div>' }
    ],
    quizzes: [
      { question: "How many persons in the Godhead?", options: ["One", "Two", "Three", "Four"], correct: 2, explanation: "Three: Father, Son, Holy Spirit." },
      { question: "How is salvation received?", options: ["Good works", "Grace by faith", "Church membership", "Baptism alone"], correct: 1, explanation: "Through grace by faith." },
      { question: "Purpose of Spirit Baptism?", options: ["Guarantee salvation", "Replace water baptism", "Endue with power", "Eliminate Scripture"], correct: 2, explanation: "To endue with power." },
      { question: "Divine healing belief?", options: ["Ended with apostles", "Replaces doctors", "Jesus still heals", "Guaranteed for all"], correct: 2, explanation: "Jesus heals in answer to prayer." },
      { question: "Christ's second coming?", options: ["Symbolic", "Already fulfilled", "Personal and imminent", "Uncertain"], correct: 2, explanation: "Personal and imminent." }
    ]
  },
  {
    id: 'polity', name: 'Polity', icon: '‚öñÔ∏è', color: 'from-emerald-500 to-teal-600',
    description: 'Learn Foursquare governance.',
    lessons: [
      { title: 'Foursquare Governance', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Church Government</h3><p>The Foursquare Convention is the chief decision-making body. Board of Directors (12-24) manages the Church. The President provides overall leadership.</p>' },
      { title: 'Districts and Local Churches', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Structure</h3><p>Districts are overseen by District Supervisors. Local churches have Church Councils working with the pastor.</p>' },
      { title: 'Licensing and Ordination', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Credentialing</h3><p>Licensing and appointment are mutually dependent. Ordination comes after two years of faithful service.</p>' },
      { title: 'Financial Accountability', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Stewardship</h3><p>Churches pay a tithe of tithes to ICFG and file monthly reports.</p>' }
    ],
    quizzes: [
      { question: "Chief decision-making body?", options: ["Board of Directors", "The President", "The Foursquare Convention", "District Supervisors"], correct: 2, explanation: "The Convention." },
      { question: "Licensing and appointment?", options: ["Unrelated", "Licensing first", "Mutually dependent", "Appointment replaces"], correct: 2, explanation: "Mutually dependent." },
      { question: "Financial obligation to ICFG?", options: ["None", "Tithe of tithes", "50%", "Missions only"], correct: 1, explanation: "Tithe of tithes." },
      { question: "Regional oversight?", options: ["President", "Board", "District Supervisor", "Convention"], correct: 2, explanation: "District Supervisors." },
      { question: "Years before ordination?", options: ["One", "Two", "Five", "Ten"], correct: 1, explanation: "Two years." }
    ]
  },
  {
    id: 'practice', name: 'Ministry Practice', icon: 'üôè', color: 'from-rose-500 to-pink-600',
    description: 'Apply ministry principles.',
    lessons: [
      { title: 'The Ordinances', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Baptism and Lord\'s Supper</h3><p>Water baptism is an outward sign of an inward work. The Lord\'s Supper remembers Christ.</p>' },
      { title: 'Spirit-Empowered Ministry', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">The Spirit-Filled Life</h3><p>Walk in the Spirit moment by moment.</p>' },
      { title: 'Evangelism and Pastoral Care', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Soul Winning</h3><p>Soul winning is the one big business of the Church.</p>' },
      { title: 'Church Life', content: '<h3 class="text-xl font-bold text-slate-800 mb-4">Church Relationship</h3><p>It is our sacred duty to identify with and labor for the visible church.</p>' }
    ],
    quizzes: [
      { question: "Foursquare ordinances?", options: ["Foot washing", "Baptism and Lord's Supper", "Confession", "Infant baptism"], correct: 1, explanation: "Water baptism and Lord's Supper." },
      { question: "'One big business' of Church?", options: ["Building", "Soul winning", "Politics", "Finance"], correct: 1, explanation: "Soul winning." },
      { question: "Article XIII teaches?", options: ["Extremes", "Balanced moderation", "Emotion primary", "Doctrine unimportant"], correct: 1, explanation: "Sober, balanced, Christ-like." },
      { question: "Water baptism is?", options: ["For salvation", "Outward sign", "For infants", "Optional"], correct: 1, explanation: "Outward sign of inward work." },
      { question: "Why join visible church?", options: ["Status", "Optional", "Sacred duty", "Ministers only"], correct: 2, explanation: "Sacred duty." }
    ]
  }
];

// STATE
var currentUser = null;
var userProgress = null;
var currentDomain = null;
var currentLessonIndex = 0;
var currentQuizIndex = 0;
var selectedAnswer = null;
var quizScore = 0;

// HELPER FUNCTIONS
function showScreen(id) {
  var screens = document.querySelectorAll('.screen');
  for (var i = 0; i < screens.length; i++) {
    screens[i].classList.remove('active');
  }
  document.getElementById('screen-' + id).classList.add('active');
}

function showError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.classList.remove('hidden');
}

function hideError() {
  document.getElementById('login-error').classList.add('hidden');
}

function showLoading(show) {
  document.getElementById('login-loading').classList.toggle('hidden', !show);
}

function showSaveStatus() {
  var el = document.getElementById('save-status');
  el.classList.remove('hidden');
  setTimeout(function() { el.classList.add('hidden'); }, 2000);
}

function createDefaultProgress() {
  var p = {};
  for (var i = 0; i < DOMAINS.length; i++) {
    p[DOMAINS[i].id] = { lessonsCompleted: [], quizScores: [], completed: false };
  }
  return p;
}

// AUTH FUNCTIONS
async function handleRegister() {
  var name = document.getElementById('reg-name').value.trim();
  var email = document.getElementById('reg-email').value.trim();
  var password = document.getElementById('reg-password').value;
  
  if (!name || !email || !password) { showError('Please fill all fields'); return; }
  if (password.length < 6) { showError('Password must be at least 6 characters'); return; }
  
  if (!supabase) {
    showError('Cloud service unavailable. Please refresh the page and try again.');
    return;
  }
  
  hideError();
  showLoading(true);
  
  try {
    var result = await supabase.auth.signUp({ 
      email: email, 
      password: password,
      options: { data: { name: name } }
    });
    if (result.error) throw result.error;
    if (result.data.user) {
      currentUser = result.data.user;
      userProgress = createDefaultProgress();
      await saveProgress();
      showApp();
    }
  } catch (e) {
    showError(e.message || 'Registration failed');
  }
  showLoading(false);
}

async function handleLogin() {
  var email = document.getElementById('login-email').value.trim();
  var password = document.getElementById('login-password').value;
  
  if (!email || !password) { showError('Please fill all fields'); return; }
  
  if (!supabase) {
    showError('Cloud service unavailable. Please refresh the page and try again.');
    return;
  }
  
  hideError();
  showLoading(true);
  
  try {
    var result = await supabase.auth.signInWithPassword({ email: email, password: password });
    if (result.error) throw result.error;
    currentUser = result.data.user;
    await loadProgress();
    showApp();
  } catch (e) {
    showError(e.message || 'Login failed');
  }
  showLoading(false);
}

async function handleLogout() {
  if (supabase) await supabase.auth.signOut();
  currentUser = null;
  userProgress = null;
  showScreen('login');
}

// PROGRESS FUNCTIONS
async function loadProgress() {
  try {
    var result = await supabase.from('progress').select('data').eq('user_id', currentUser.id).single();
    if (result.data && result.data.data) {
      userProgress = result.data.data;
    } else {
      userProgress = createDefaultProgress();
      await saveProgress();
    }
  } catch (e) {
    userProgress = createDefaultProgress();
  }
  // Ensure all domains exist
  for (var i = 0; i < DOMAINS.length; i++) {
    if (!userProgress[DOMAINS[i].id]) {
      userProgress[DOMAINS[i].id] = { lessonsCompleted: [], quizScores: [], completed: false };
    }
  }
}

async function saveProgress() {
  try {
    await supabase.from('progress').upsert({
      user_id: currentUser.id,
      data: userProgress,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });
    showSaveStatus();
  } catch (e) {
    console.error('Save failed:', e);
  }
}

// APP FUNCTIONS
function showApp() {
  showScreen('app');
  var name = 'Student';
  if (currentUser && currentUser.user_metadata && currentUser.user_metadata.name) {
    name = currentUser.user_metadata.name;
  } else if (currentUser && currentUser.email) {
    name = currentUser.email.split('@')[0];
  }
  document.getElementById('user-greeting').textContent = 'Welcome, ' + name + '!';
  renderDomainCards();
  updateOverallProgress();
}

function backToApp() {
  showApp();
}

function renderDomainCards() {
  var container = document.getElementById('domain-cards');
  var html = '';
  
  for (var i = 0; i < DOMAINS.length; i++) {
    var d = DOMAINS[i];
    var p = userProgress[d.id];
    var done = p.lessonsCompleted.length;
    var total = d.lessons.length;
    var pct = Math.round((done/total)*100);
    var locked = i > 0 && !userProgress[DOMAINS[i-1].id].completed;
    var complete = p.completed;
    
    html += '<div class="bg-white rounded-xl shadow-sm border p-6 ' + (locked ? 'opacity-60' : '') + '">';
    html += '<div class="flex items-center justify-between mb-4">';
    html += '<div class="text-3xl">' + d.icon + '</div>';
    if (complete) html += '<span class="text-green-500 text-xl">‚úì</span>';
    else if (locked) html += '<span class="text-slate-400">üîí</span>';
    html += '</div>';
    html += '<h3 class="text-lg font-bold text-slate-800 mb-1">' + d.name + '</h3>';
    html += '<p class="text-slate-500 text-sm mb-4">' + d.description + '</p>';
    html += '<div class="mb-4">';
    html += '<div class="flex justify-between text-sm mb-1"><span>Progress</span><span>' + done + '/' + total + '</span></div>';
    html += '<div class="w-full bg-slate-100 rounded-full h-2"><div class="bg-gradient-to-r ' + d.color + ' h-2 rounded-full" style="width:' + pct + '%"></div></div>';
    html += '</div>';
    
    if (locked) {
      html += '<button disabled class="w-full py-2 rounded-lg border text-slate-400">Complete previous domain</button>';
    } else if (complete) {
      html += '<div class="flex gap-2">';
      html += '<button class="flex-1 py-2 rounded-lg border hover:bg-slate-50" onclick="startLessons(\'' + d.id + '\')">Review</button>';
      html += '<button class="flex-1 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700" onclick="startQuiz(\'' + d.id + '\')">Retake</button>';
      html += '</div>';
    } else if (done === total) {
      html += '<button class="w-full py-2 rounded-lg bg-gradient-to-r ' + d.color + ' text-white" onclick="startQuiz(\'' + d.id + '\')">Take Quiz ‚Üí</button>';
    } else {
      html += '<button class="w-full py-2 rounded-lg bg-gradient-to-r ' + d.color + ' text-white" onclick="startLessons(\'' + d.id + '\')">' + (done > 0 ? 'Continue' : 'Start') + ' ‚Üí</button>';
    }
    html += '</div>';
  }
  
  container.innerHTML = html;
}

function updateOverallProgress() {
  var total = 0, done = 0;
  for (var i = 0; i < DOMAINS.length; i++) {
    total += DOMAINS[i].lessons.length;
    done += userProgress[DOMAINS[i].id].lessonsCompleted.length;
  }
  var pct = Math.round((done/total)*100);
  document.getElementById('overall-progress').textContent = pct + '%';
  document.getElementById('progress-bar').style.width = pct + '%';
}

// LESSON FUNCTIONS
function startLessons(id) {
  for (var i = 0; i < DOMAINS.length; i++) {
    if (DOMAINS[i].id === id) {
      currentDomain = DOMAINS[i];
      break;
    }
  }
  var p = userProgress[id];
  currentLessonIndex = 0;
  for (var j = 0; j < currentDomain.lessons.length; j++) {
    if (p.lessonsCompleted.indexOf(j) === -1) {
      currentLessonIndex = j;
      break;
    }
    currentLessonIndex = j;
  }
  showLesson();
}

function showLesson() {
  showScreen('lesson');
  var lesson = currentDomain.lessons[currentLessonIndex];
  document.getElementById('lesson-domain-label').textContent = currentDomain.name;
  document.getElementById('lesson-title').textContent = lesson.title;
  document.getElementById('lesson-progress').textContent = (currentLessonIndex + 1) + '/' + currentDomain.lessons.length;
  document.getElementById('lesson-content').innerHTML = lesson.content;
  
  if (currentLessonIndex === 0) {
    document.getElementById('btn-prev').classList.add('hidden');
  } else {
    document.getElementById('btn-prev').classList.remove('hidden');
  }
  
  if (currentLessonIndex === currentDomain.lessons.length - 1) {
    document.getElementById('btn-next').textContent = 'Take Quiz ‚Üí';
  } else {
    document.getElementById('btn-next').textContent = 'Continue ‚Üí';
  }
}

function prevLesson() {
  if (currentLessonIndex > 0) {
    currentLessonIndex--;
    showLesson();
  }
}

async function nextLesson() {
  var p = userProgress[currentDomain.id];
  if (p.lessonsCompleted.indexOf(currentLessonIndex) === -1) {
    p.lessonsCompleted.push(currentLessonIndex);
    await saveProgress();
  }
  if (currentLessonIndex < currentDomain.lessons.length - 1) {
    currentLessonIndex++;
    showLesson();
  } else {
    startQuiz(currentDomain.id);
  }
}

// QUIZ FUNCTIONS
function startQuiz(id) {
  for (var i = 0; i < DOMAINS.length; i++) {
    if (DOMAINS[i].id === id) {
      currentDomain = DOMAINS[i];
      break;
    }
  }
  currentQuizIndex = 0;
  selectedAnswer = null;
  quizScore = 0;
  showQuizQuestion();
}

function showQuizQuestion() {
  showScreen('quiz');
  var q = currentDomain.quizzes[currentQuizIndex];
  document.getElementById('quiz-domain-label').textContent = currentDomain.name;
  document.getElementById('quiz-progress').textContent = (currentQuizIndex + 1) + '/' + currentDomain.quizzes.length;
  document.getElementById('quiz-question').textContent = q.question;
  
  var optionsHtml = '';
  var letters = ['A', 'B', 'C', 'D'];
  for (var i = 0; i < q.options.length; i++) {
    optionsHtml += '<button class="quiz-option w-full p-4 border-2 rounded-lg text-left flex items-center gap-3" onclick="selectQuizOption(' + i + ')" data-index="' + i + '">';
    optionsHtml += '<span class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold">' + letters[i] + '</span>';
    optionsHtml += '<span>' + q.options[i] + '</span>';
    optionsHtml += '</button>';
  }
  document.getElementById('quiz-options').innerHTML = optionsHtml;
  
  document.getElementById('quiz-feedback').classList.add('hidden');
  document.getElementById('btn-submit').classList.remove('hidden');
  document.getElementById('btn-submit').disabled = true;
  document.getElementById('btn-next-q').classList.add('hidden');
  selectedAnswer = null;
}

function selectQuizOption(index) {
  selectedAnswer = index;
  var options = document.querySelectorAll('.quiz-option');
  for (var i = 0; i < options.length; i++) {
    if (i === index) {
      options[i].classList.add('selected');
    } else {
      options[i].classList.remove('selected');
    }
  }
  document.getElementById('btn-submit').disabled = false;
}

function submitAnswer() {
  var q = currentDomain.quizzes[currentQuizIndex];
  var correct = selectedAnswer === q.correct;
  if (correct) quizScore++;
  
  var options = document.querySelectorAll('.quiz-option');
  for (var i = 0; i < options.length; i++) {
    options[i].classList.remove('selected');
    options[i].onclick = null;
    var idx = parseInt(options[i].getAttribute('data-index'));
    if (idx === q.correct) {
      options[i].classList.add('correct');
    } else if (idx === selectedAnswer && !correct) {
      options[i].classList.add('incorrect');
    }
  }
  
  var fb = document.getElementById('quiz-feedback');
  fb.classList.remove('hidden');
  if (correct) {
    fb.className = 'mt-6 p-4 rounded-lg bg-green-50 border border-green-200';
    fb.innerHTML = '<div class="font-medium text-green-800">‚úì Correct!</div><div class="text-sm mt-1">' + q.explanation + '</div>';
  } else {
    fb.className = 'mt-6 p-4 rounded-lg bg-red-50 border border-red-200';
    fb.innerHTML = '<div class="font-medium text-red-800">‚úó Incorrect</div><div class="text-sm mt-1">' + q.explanation + '</div>';
  }
  
  document.getElementById('btn-submit').classList.add('hidden');
  document.getElementById('btn-next-q').classList.remove('hidden');
  
  if (currentQuizIndex === currentDomain.quizzes.length - 1) {
    document.getElementById('btn-next-q').textContent = 'See Results';
  } else {
    document.getElementById('btn-next-q').textContent = 'Next ‚Üí';
  }
}

function nextQuestion() {
  if (currentQuizIndex < currentDomain.quizzes.length - 1) {
    currentQuizIndex++;
    showQuizQuestion();
  } else {
    showResults();
  }
}

async function showResults() {
  showScreen('results');
  var total = currentDomain.quizzes.length;
  var pct = Math.round((quizScore / total) * 100);
  var passed = pct >= 80;
  
  var p = userProgress[currentDomain.id];
  p.quizScores.push(pct);
  if (passed && !p.completed) p.completed = true;
  await saveProgress();
  
  document.getElementById('results-icon').textContent = passed ? 'üéâ' : 'üìö';
  document.getElementById('results-title').textContent = passed ? 'Great Job!' : 'Keep Studying';
  document.getElementById('results-message').textContent = passed ? 'You passed with ' + quizScore + '/' + total + '!' : quizScore + '/' + total + ' - Need 80% to pass.';
  document.getElementById('results-correct').textContent = quizScore;
  document.getElementById('results-incorrect').textContent = total - quizScore;
  document.getElementById('results-percent').textContent = pct + '%';
}

function retakeQuiz() {
  startQuiz(currentDomain.id);
}

// EVENT LISTENERS
document.getElementById('btn-login').onclick = handleLogin;
document.getElementById('btn-register').onclick = handleRegister;
document.getElementById('btn-logout').onclick = handleLogout;
document.getElementById('lesson-back').onclick = backToApp;
document.getElementById('quiz-back').onclick = backToApp;
document.getElementById('btn-prev').onclick = prevLesson;
document.getElementById('btn-next').onclick = nextLesson;
document.getElementById('btn-submit').onclick = submitAnswer;
document.getElementById('btn-next-q').onclick = nextQuestion;
document.getElementById('btn-retake').onclick = retakeQuiz;
document.getElementById('btn-continue').onclick = backToApp;

// CHECK SESSION ON LOAD
function checkExistingSession() {
  if (supabase) {
    supabase.auth.getSession().then(function(result) {
      if (result.data.session) {
        currentUser = result.data.session.user;
        loadProgress().then(function() {
          showApp();
        });
      }
    }).catch(function(e) {
      console.error('Session check error:', e);
    });
  }
}
</script>
</body>
</html>
