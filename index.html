<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foursquare Licensing University</title>
  <script src="https://cdn.tailwindcss.com"></script>
<!-- closing divs fixed -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: #f8fafc; }
    
    /* Responsive app container */
    .app-container { 
      width: 100%; 
      min-height: 100vh; 
      background: #f8fafc; 
      position: relative;
      padding-bottom: 70px;
    }
    
    /* Tablet (768px+) */
    @media (min-width: 768px) {
      body { background: #e2e8f0; }
      .app-container { 
        max-width: 768px; 
        margin: 0 auto; 
        box-shadow: 0 0 40px rgba(0,0,0,0.1); 
      }
      .bottom-nav { max-width: 768px; }
      .main-content { padding: 20px 24px; }
      .metric-grid { grid-template-columns: repeat(4, 1fr); }
      .chapter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .study-section-content { font-size: 17px; line-height: 1.9; }
    }
    
    /* Desktop (1024px+) */
    @media (min-width: 1024px) {
      .app-container { 
        max-width: 1024px; 
      }
      .bottom-nav { max-width: 1024px; }
      .main-content { padding: 24px 32px; }
      .domain-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .study-section-content { font-size: 18px; line-height: 2; padding: 20px; }
      .reading-content { font-size: 18px; }
    }
    
    /* Large Desktop (1280px+) */
    @media (min-width: 1280px) {
      .app-container { 
        max-width: 1200px; 
      }
      .bottom-nav { max-width: 1200px; }
      .chapter-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    .screen { display: none; }
    .screen.active { display: block; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; background: white; border-top: 1px solid #e5e7eb; z-index: 100; }
    .nav-item { flex: 1; padding: 8px 4px; text-align: center; color: #64748b; cursor: pointer; transition: all 0.2s; }
    .nav-item:hover { color: #dc2626; }
    .nav-item.active { color: #dc2626; }
    .nav-item svg { width: 24px; height: 24px; margin: 0 auto 2px; }
    @media (min-width: 768px) {
      .nav-item { padding: 12px 8px; }
      .nav-item svg { width: 28px; height: 28px; }
      .nav-item span { font-size: 13px; }
    }
    
    .main-card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 16px; }
    .section-header { padding: 16px 20px; cursor: pointer; }
    .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
    .section-content.expanded { max-height: 5000px; }
    .chapter-item { display: flex; align-items: center; padding: 14px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; }
    .chapter-item:last-child { border-bottom: none; }
    .chapter-item:hover { background: #f8fafc; transform: translateX(4px); }
    
    .progress-ring { transform: rotate(-90deg); }
    .metric-card { background: white; border-radius: 12px; padding: 12px 8px; text-align: center; border: 1px solid #e5e7eb; }
    .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (min-width: 480px) { .metric-grid { grid-template-columns: repeat(4, 1fr); } }
    
    /* Study section with fixed navigation */
    .study-container { position: relative; min-height: calc(100vh - 200px); padding-bottom: 80px; }
    .study-section { padding: 16px; }
    .study-section h4 { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 16px; }
    .study-section-content { font-size: 16px; line-height: 1.8; color: #374151; }
    .study-section-content p { margin-bottom: 16px; }
    .study-section-content ul, .study-section-content ol { margin: 16px 0; padding-left: 24px; }
    .study-section-content li { margin-bottom: 12px; }
    .study-nav-fixed { 
      position: fixed; 
      bottom: 70px; 
      left: 50%; 
      transform: translateX(-50%); 
      width: 100%; 
      max-width: inherit;
      background: white; 
      padding: 12px 16px; 
      border-top: 1px solid #e5e7eb; 
      display: flex; 
      justify-content: space-between; 
      gap: 12px;
      z-index: 90;
    }
    @media (min-width: 768px) { .study-nav-fixed { max-width: 768px; padding: 16px 24px; } }
    @media (min-width: 1024px) { .study-nav-fixed { max-width: 1024px; } }
    @media (min-width: 1280px) { .study-nav-fixed { max-width: 1200px; } }
    
    /* Reading styles */
    .reader-container { min-height: 100vh; }
    .reader-container.theme-light { background: #fff; color: #1a1a1a; }
    .reader-container.theme-sepia { background: #f4ecd8; color: #5c4b37; }
    .reader-container.theme-dark { background: #1a1a1a; color: #e0e0e0; }
    .font-serif { font-family: 'Merriweather', Georgia, serif; }
    .font-sans { font-family: 'Inter', system-ui, sans-serif; }
    
    /* Highlights */
    .highlight-yellow { background: rgba(250, 204, 21, 0.4); }
    .highlight-green { background: rgba(74, 222, 128, 0.4); }
    .highlight-blue { background: rgba(96, 165, 250, 0.4); }
    .highlight-pink { background: rgba(244, 114, 182, 0.4); }
    .selection-popup { position: absolute; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 8px; display: none; z-index: 200; }
    .selection-popup.show { display: flex; gap: 4px; }
    
    /* Study elements */
    .key-term { background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
    .scripture-box { background: #eff6ff; padding: 14px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #3b82f6; }
    .key-point { background: #f0fdf4; padding: 14px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #22c55e; }
    .warning-box { background: #fef2f2; padding: 14px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #ef4444; }
    
    /* Tabs */
    .tab-bar { display: flex; background: #f1f5f9; border-radius: 12px; padding: 4px; margin-bottom: 16px; }
    .tab-btn { flex: 1; padding: 10px 4px; border-radius: 8px; text-align: center; font-weight: 500; color: #64748b; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .tab-btn:hover { color: #1e293b; }
    .tab-btn.active { background: white; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    @media (min-width: 768px) { .tab-btn { font-size: 14px; padding: 12px 8px; } }
    
    /* Quiz */
    .quiz-option { transition: all 0.2s; cursor: pointer; }
    .quiz-option:hover { transform: translateX(4px); background: #f8fafc; }
    .quiz-option.selected { border-color: #3b82f6 !important; background: #eff6ff !important; }
    .quiz-option.correct { border-color: #10b981 !important; background: #d1fae5 !important; }
    .quiz-option.incorrect { border-color: #ef4444 !important; background: #fee2e2 !important; }
    
    .loading-spinner { border: 3px solid #e5e7eb; border-top-color: #dc2626; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .note-card { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; border-left: 3px solid #3b82f6; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    .reading-content { line-height: 1.9; }
    .reading-content h2 { font-size: 1.3rem; font-weight: 700; margin: 1.5rem 0 1rem 0; color: #1e293b; }
    .reading-content h3 { font-size: 1.1rem; font-weight: 600; margin: 1.25rem 0 0.75rem 0; color: #334155; }
    .reading-content p { margin-bottom: 1rem; }
    .reading-content ul, .reading-content ol { margin: 1rem 0; padding-left: 1.5rem; }
    .reading-content li { margin-bottom: 0.5rem; }
    
    /* Guidance cards */
    .guidance-card { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; }
    .next-step-card { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; cursor: pointer; }
    .recent-activity { background: white; border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; border-left: 3px solid #6366f1; }
    .bookmark-quick { background: #fef3c7; border-radius: 10px; padding: 10px 14px; margin-bottom: 8px; cursor: pointer; }
    
    /* Study progress */
    .study-section { background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
    .study-section h4 { font-weight: 600; margin-bottom: 10px; color: #1e293b; font-size: 15px; }
    .study-section-content { color: #475569; line-height: 1.7; }
    .discussion-q { background: #dbeafe; padding: 12px 14px; border-radius: 8px; margin-top: 12px; font-style: italic; }
    
    /* Difficulty indicator */
    .difficulty-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .difficulty-easy { background: #d1fae5; color: #065f46; }
    .difficulty-medium { background: #fef3c7; color: #92400e; }
    .difficulty-hard { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
<div class="app-container">

<!-- LOGIN SCREEN -->
<div id="screen-login" class="screen active">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full p-8">
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-red-600 to-red-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        </div>
        <h1 class="text-2xl font-bold text-slate-800">Foursquare Licensing</h1>
        <p class="text-slate-500 mt-2">University-Level Ministry Preparation</p>
      </div>
      <div id="login-form">
        <div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="login-email" class="w-full border border-slate-300 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"></div>
        <div class="mb-6"><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" id="login-password" class="w-full border border-slate-300 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"></div>
        <button id="btn-login" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl font-semibold hover:from-red-700 hover:to-red-800 transition">Sign In</button>
        <p class="text-center text-sm text-slate-500 mt-4">No account? <span id="link-register" class="text-red-600 cursor-pointer font-medium">Create one</span></p>
      </div>
      <div id="register-form" style="display:none;">
        <div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label><input type="text" id="reg-name" class="w-full border border-slate-300 rounded-xl px-4 py-3"></div>
        <div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" id="reg-email" class="w-full border border-slate-300 rounded-xl px-4 py-3"></div>
        <div class="mb-6"><label class="block text-sm font-medium text-slate-700 mb-1">Password</label><input type="password" id="reg-password" class="w-full border border-slate-300 rounded-xl px-4 py-3"></div>
        <button id="btn-register" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-3 rounded-xl font-semibold">Create Account</button>
        <p class="text-center text-sm text-slate-500 mt-4">Have account? <span id="link-login" class="text-red-600 cursor-pointer font-medium">Sign in</span></p>
      </div>
      <div id="login-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm"></div>
    </div>
  </div>
</div>

<!-- HOME SCREEN -->
<div id="screen-home" class="screen">
  <header class="bg-gradient-to-r from-red-700 to-red-800 text-white px-4 pt-12 pb-6">
    <div class="flex items-center justify-between mb-4">
      <div><p class="text-red-200 text-sm">Welcome back,</p><h1 class="text-xl font-bold" id="user-name">Student</h1></div>
      <button onclick="handleLogout()" class="text-red-200 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
    <div class="bg-white/10 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div><div class="text-3xl font-bold" id="total-progress">0%</div><div class="text-red-200 text-sm">Overall Progress</div></div>
        <svg class="progress-ring" width="60" height="60"><circle cx="30" cy="30" r="26" stroke="rgba(255,255,255,0.2)" stroke-width="5" fill="none"/><circle id="progress-ring-circle" cx="30" cy="30" r="26" stroke="white" stroke-width="5" fill="none" stroke-dasharray="163.36" stroke-dashoffset="163.36" stroke-linecap="round"/></svg>
      </div>
    </div>
  </header>
  
  <main class="px-4 py-4 pb-24">
    <!-- Stats Row -->
    <div class="grid grid-cols-4 gap-2 mb-4">
      <div class="metric-card"><div class="text-xl font-bold text-red-600" id="stat-chapters">0</div><div class="text-xs text-slate-500">Read</div></div>
      <div class="metric-card"><div class="text-xl font-bold text-green-600" id="stat-studied">0</div><div class="text-xs text-slate-500">Studied</div></div>
      <div class="metric-card"><div class="text-xl font-bold text-blue-600" id="stat-quizzes">0</div><div class="text-xs text-slate-500">Quizzes</div></div>
      <div class="metric-card"><div class="text-xl font-bold text-purple-600" id="stat-notes">0</div><div class="text-xs text-slate-500">Notes</div></div>
    </div>
    
    <!-- Guidance Section - What to do next -->
    <div id="guidance-section"></div>
    
    <!-- Quick Bookmarks -->
    <div id="bookmarks-section" class="mb-4"></div>
    
    <!-- Recent Activity -->
    <div id="recent-section" class="mb-4"></div>
    
    <!-- Licensing Domains -->
    <div class="main-card" id="domains-card">
      <div class="section-header flex items-center justify-between" onclick="toggleSection('domains')">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 bg-gradient-to-br from-red-500 to-red-700 rounded-xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></div>
          <div><h2 class="font-bold text-slate-800">Licensing Domains</h2><p class="text-xs text-slate-500">5 Core Areas ‚Ä¢ Required</p></div>
        </div>
        <div class="flex items-center gap-2"><div class="text-sm font-bold text-slate-600" id="domains-progress">0%</div><svg class="w-5 h-5 text-slate-400 transition-transform" id="domains-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="section-content" id="domains-content"></div>
    </div>
    
    <!-- Required Books -->
    <div class="main-card" id="books-card">
      <div class="section-header flex items-center justify-between" onclick="toggleSection('books')">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-purple-700 rounded-xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>
          <div><h2 class="font-bold text-slate-800">Required Reading</h2><p class="text-xs text-slate-500">Textbooks & Books</p></div>
        </div>
        <div class="flex items-center gap-2"><div class="text-sm font-bold text-slate-600" id="books-progress">0%</div><svg class="w-5 h-5 text-slate-400 transition-transform" id="books-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg></div>
      </div>
      <div class="section-content" id="books-content"></div>
    </div>
  </main>
  
  <nav class="bottom-nav"><div class="flex">
    <div class="nav-item active" onclick="showNav('home')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><div class="text-xs">Home</div></div>
    <div class="nav-item" onclick="showNav('study')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><div class="text-xs">Study</div></div>
    <div class="nav-item" onclick="showNav('notes')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><div class="text-xs">Notes</div></div>
    <div class="nav-item" onclick="showNav('profile')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><div class="text-xs">Profile</div></div>
  </div></nav>
</div>

<!-- STUDY SCREEN -->
<div id="screen-study" class="screen">
  <header class="bg-white border-b px-4 py-4 pt-12">
    <h1 class="text-xl font-bold text-slate-800">Study Materials</h1>
    <p class="text-sm text-slate-500">Complete all domains and required reading</p>
  </header>
  <main class="px-4 py-4 pb-24" id="study-list"></main>
  <nav class="bottom-nav"><div class="flex">
    <div class="nav-item" onclick="showNav('home')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><div class="text-xs">Home</div></div>
    <div class="nav-item active" onclick="showNav('study')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><div class="text-xs">Study</div></div>
    <div class="nav-item" onclick="showNav('notes')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><div class="text-xs">Notes</div></div>
    <div class="nav-item" onclick="showNav('profile')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><div class="text-xs">Profile</div></div>
  </div></nav>
</div>

<!-- NOTES SCREEN -->
<div id="screen-notes" class="screen">
  <header class="bg-white border-b px-4 py-4 pt-12">
    <h1 class="text-xl font-bold text-slate-800">My Notes & Highlights</h1>
    <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
      <button onclick="filterNotes('all')" class="notes-filter px-4 py-1.5 rounded-full text-sm font-medium bg-red-600 text-white whitespace-nowrap">All</button>
      <button onclick="filterNotes('notes')" class="notes-filter px-4 py-1.5 rounded-full text-sm font-medium bg-slate-100 whitespace-nowrap">Notes</button>
      <button onclick="filterNotes('highlights')" class="notes-filter px-4 py-1.5 rounded-full text-sm font-medium bg-slate-100 whitespace-nowrap">Highlights</button>
      <button onclick="filterNotes('bookmarks')" class="notes-filter px-4 py-1.5 rounded-full text-sm font-medium bg-slate-100 whitespace-nowrap">Bookmarks</button>
    </div>
  </header>
  <main class="px-4 py-4 pb-24" id="notes-list"></main>
  <nav class="bottom-nav"><div class="flex">
    <div class="nav-item" onclick="showNav('home')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><div class="text-xs">Home</div></div>
    <div class="nav-item" onclick="showNav('study')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><div class="text-xs">Study</div></div>
    <div class="nav-item active" onclick="showNav('notes')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><div class="text-xs">Notes</div></div>
    <div class="nav-item" onclick="showNav('profile')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><div class="text-xs">Profile</div></div>
  </div></nav>
</div>

<!-- PROFILE SCREEN -->
<div id="screen-profile" class="screen">
  <header class="bg-gradient-to-r from-red-700 to-red-800 text-white px-4 pt-12 pb-6">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold" id="profile-avatar">S</div>
      <div><h1 class="text-xl font-bold" id="profile-name">Student</h1><p class="text-red-200 text-sm" id="profile-email"></p></div>
    </div>
  </header>
  <main class="px-4 py-4 pb-24">
    <div class="main-card p-4 mb-4">
      <h3 class="font-bold text-slate-800 mb-4">üìä Your Statistics</h3>
      <div class="space-y-3">
        <div class="flex justify-between items-center"><span class="text-slate-600">Chapters Read</span><span class="font-bold text-lg" id="profile-chapters">0</span></div>
        <div class="flex justify-between items-center"><span class="text-slate-600">Study Guides Completed</span><span class="font-bold text-lg" id="profile-studied">0</span></div>
        <div class="flex justify-between items-center"><span class="text-slate-600">Quizzes Passed (80%+)</span><span class="font-bold text-lg" id="profile-quizzes">0</span></div>
        <div class="flex justify-between items-center"><span class="text-slate-600">Notes & Highlights</span><span class="font-bold text-lg" id="profile-notes">0</span></div>
        <div class="flex justify-between items-center"><span class="text-slate-600">Bookmarks</span><span class="font-bold text-lg" id="profile-bookmarks">0</span></div>
      </div>
    </div>
    <div class="main-card p-4 mb-4">
      <h3 class="font-bold text-slate-800 mb-4">üéØ Licensing Progress</h3>
      <div class="space-y-3">
        <div><div class="flex justify-between text-sm mb-1"><span>Domains</span><span id="profile-domains-pct">0%</span></div><div class="h-2 bg-slate-200 rounded-full"><div class="h-full bg-red-500 rounded-full transition-all" id="profile-domains-bar" style="width:0%"></div></div></div>
        <div><div class="flex justify-between text-sm mb-1"><span>Required Books</span><span id="profile-books-pct">0%</span></div><div class="h-2 bg-slate-200 rounded-full"><div class="h-full bg-indigo-500 rounded-full transition-all" id="profile-books-bar" style="width:0%"></div></div></div>
      </div>
    </div>
    <div class="main-card p-4">
      <h3 class="font-bold text-slate-800 mb-4">‚öôÔ∏è Settings</h3>
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-slate-600 mb-2">TTS Voice</label><select id="voice-select" class="w-full border border-slate-300 rounded-lg px-3 py-2" onchange="saveVoicePref()"></select></div>
      </div>
    </div>
  </main>
  <nav class="bottom-nav"><div class="flex">
    <div class="nav-item" onclick="showNav('home')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><div class="text-xs">Home</div></div>
    <div class="nav-item" onclick="showNav('study')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><div class="text-xs">Study</div></div>
    <div class="nav-item" onclick="showNav('notes')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><div class="text-xs">Notes</div></div>
    <div class="nav-item active" onclick="showNav('profile')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><div class="text-xs">Profile</div></div>
  </div></nav>
</div>

<!-- CHAPTER SCREEN -->
<div id="screen-chapter" class="screen">
  <header class="bg-white border-b px-4 py-3 pt-10 flex items-center gap-3">
    <button onclick="backFromChapter()" class="p-2 -ml-2 hover:bg-slate-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
    <div class="flex-1 min-w-0"><h1 class="font-bold text-slate-800 truncate" id="chapter-title">Chapter</h1><p class="text-sm text-slate-500 truncate" id="chapter-subtitle">Category</p></div>
  </header>
  <div class="tab-bar mx-4 mt-4">
    <div class="tab-btn active" data-tab="overview" onclick="switchChapterTab('overview')">Overview</div>
    <div class="tab-btn" data-tab="read" onclick="switchChapterTab('read')">Read</div>
    <div class="tab-btn" data-tab="study" onclick="switchChapterTab('study')">Study</div>
    <div class="tab-btn" data-tab="quiz" onclick="switchChapterTab('quiz')">Quiz</div>
  </div>
  <main class="px-4 py-4 pb-8">
    <div id="chapter-tab-overview" class="chapter-tab"></div>
    <div id="chapter-tab-read" class="chapter-tab hidden"></div>
    <div id="chapter-tab-study" class="chapter-tab hidden"></div>
    <div id="chapter-tab-quiz" class="chapter-tab hidden"></div>
  </main>
</div>

<!-- READER SCREEN -->
<div id="screen-reader" class="screen">
  <div id="reader-container" class="reader-container theme-light font-serif">
    <div class="fixed top-0 left-0 right-0 h-1 bg-slate-200 z-50"><div id="reading-progress-bar" class="h-full bg-red-500 transition-all" style="width:0%"></div></div>
    <header class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur border-b z-40 px-4 py-3 flex items-center justify-between" id="reader-header" style="max-width:480px;margin:0 auto;">
      <button onclick="closeReader()" class="p-2 -ml-2 hover:bg-slate-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
      <div class="text-center flex-1"><div class="font-medium text-sm truncate" id="reader-title-bar">Chapter</div><div class="text-xs text-slate-500" id="reader-page-indicator">Page 1/1</div></div>
      <div class="flex gap-1">
        <button onclick="toggleBookmark()" id="btn-bookmark" class="p-2 hover:bg-slate-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg></button>
        <button onclick="toggleReaderSettings()" class="p-2 hover:bg-slate-100 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      </div>
    </header>
    <div class="pt-16 pb-40 px-4"><div class="max-w-2xl mx-auto reading-content" id="reader-page-content" style="font-size:18px;"></div></div>
    <div class="selection-popup" id="selection-popup">
      <button onclick="addHighlight('yellow')" class="w-8 h-8 rounded-full bg-yellow-300 border-2 border-yellow-400 hover:scale-110 transition"></button>
      <button onclick="addHighlight('green')" class="w-8 h-8 rounded-full bg-green-300 border-2 border-green-400 hover:scale-110 transition"></button>
      <button onclick="addHighlight('blue')" class="w-8 h-8 rounded-full bg-blue-300 border-2 border-blue-400 hover:scale-110 transition"></button>
      <button onclick="addNoteToSelection()" class="w-8 h-8 rounded-full bg-white border-2 border-slate-300 text-sm hover:scale-110 transition">üìù</button>
    </div>
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t z-40 px-4 py-3" id="reader-footer" style="max-width:480px;margin:0 auto;">
      <div class="flex items-center justify-between">
        <button onclick="prevPage()" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-30" id="btn-prev">‚Üê Prev</button>
        <div class="flex items-center gap-2"><input type="number" id="page-input" class="w-14 text-center border border-slate-300 rounded-lg py-1" min="1"><span class="text-slate-500">/ <span id="total-pages">1</span></span></div>
        <button onclick="nextPage()" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-30" id="btn-next">Next ‚Üí</button>
      </div>
      <div class="flex items-center justify-center gap-4 mt-3 pt-3 border-t">
        <button onclick="ttsRewind()" class="p-2 text-slate-600 hover:text-slate-900"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 19 2 12 11 5 11 19"/><polygon points="22 19 13 12 22 5 22 19"/></svg></button>
        <button onclick="toggleTTS()" id="btn-tts" class="w-12 h-12 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 transition">
          <svg id="tts-play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          <svg id="tts-pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        </button>
        <button onclick="ttsForward()" class="p-2 text-slate-600 hover:text-slate-900"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></svg></button>
        <select id="tts-speed" class="border border-slate-300 rounded-lg px-2 py-1 text-sm" onchange="updateTTSSpeed()"><option value="0.75">0.75x</option><option value="1" selected>1x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option></select>
      </div>
    </div>
    <!-- Reader Settings Panel -->
    <div id="reader-settings-panel" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end justify-center">
      <div class="bg-white w-full max-w-[480px] rounded-t-2xl p-6 max-h-[70vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Reader Settings</h3><button onclick="toggleReaderSettings()" class="p-2 hover:bg-slate-100 rounded-lg">‚úï</button></div>
        <div class="mb-6"><div class="text-sm font-medium mb-3">Theme</div><div class="flex gap-3"><button onclick="setTheme('light')" class="w-12 h-12 rounded-full bg-white border-2 border-slate-300 hover:border-slate-400"></button><button onclick="setTheme('sepia')" class="w-12 h-12 rounded-full bg-[#f4ecd8] border-2 border-slate-300 hover:border-slate-400"></button><button onclick="setTheme('dark')" class="w-12 h-12 rounded-full bg-[#1a1a1a] border-2 border-slate-300 hover:border-slate-400"></button></div></div>
        <div class="mb-6"><div class="text-sm font-medium mb-3">Font Style</div><div class="flex gap-2"><button onclick="setFont('serif')" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 font-serif">Serif</button><button onclick="setFont('sans')" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 font-sans">Sans</button></div></div>
        <div class="mb-6"><div class="text-sm font-medium mb-3">Font Size: <span id="size-display">18px</span></div><input type="range" min="14" max="28" value="18" class="w-full" id="font-size-slider" oninput="setFontSize(this.value)"></div>
        <div><div class="text-sm font-medium mb-3">Voice</div><select id="reader-voice-select" class="w-full border border-slate-300 rounded-lg px-3 py-2" onchange="setVoice(this.value)"></select></div>
      </div>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div id="note-modal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-xl max-w-lg w-full p-6">
    <h3 class="font-bold text-lg mb-2">Add Note</h3>
    <div class="text-sm text-slate-500 mb-4 italic" id="note-modal-quote"></div>
    <textarea id="note-modal-text" class="w-full border border-slate-300 rounded-lg p-3 h-32 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Write your note..."></textarea>
    <div class="flex justify-end gap-3 mt-4"><button onclick="closeNoteModal()" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50">Cancel</button><button onclick="saveNote()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Save Note</button></div>
  </div>
</div>

</div><!-- End app-container -->

<script>
// Form toggles
document.getElementById('link-register').onclick = () => { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; };
document.getElementById('link-login').onclick = () => { document.getElementById('register-form').style.display='none'; document.getElementById('login-form').style.display='block'; };

// Supabase
var supabase=null, SUPABASE_URL='https://mvuvgecqxwuqfshqbtjf.supabase.co', SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12dXZnZWNxeHd1cWZzaHFidGpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwODQ4MTUsImV4cCI6MjA4MzY2MDgxNX0.6OezNuwN5Ip2a_Xw_SsuxoB80nn3WP7D5dnhAEE9A9o';
function initSupabase(){if(window.supabase?.createClient){supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);checkSession();}}
var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js';s.onload=initSupabase;document.head.appendChild(s);

// Global State
var currentUser=null, userProgress=null, currentCategory=null, currentChapter=null;
var contentPages=[], currentPage=1, loadedContent={};
var annotations={highlights:[],notes:[],bookmarks:[]};
var expandedSections={domains:true,books:false};
var readerSettings={theme:'light',font:'serif',fontSize:18,voice:''};
var ttsPlaying=false, ttsUtterance=null, pendingSelection='';
var studyIndex=0, quizIndex=0, quizScore=0, selectedQuizAnswer=null, currentQuizSet=[];
var recentActivity=[];
try{var rs=localStorage.getItem('readerSettings');if(rs)readerSettings=JSON.parse(rs);}catch(e){}

// ========== LICENSING DOMAINS ==========
var DOMAINS = [
  {
    id: 'heritage', name: 'Heritage', icon: 'üèõÔ∏è', color: 'from-amber-500 to-orange-600', desc: 'History of Foursquare',
    chapters: [
      {
        id: 'heritage-1', title: 'Aimee Semple McPherson: Our Founder',
        summary: 'Discover the extraordinary life of Sister Aimee‚Äîfrom her conversion at 17, missionary tragedy in China, to becoming one of America\'s most influential evangelists.',
        reading: `<h2>Aimee Semple McPherson (1890-1944)</h2>
<p>Aimee Semple McPherson was a woman of intense passion, creativity, and energy who led an incredible life exemplifying God's miraculous mercy. She sparked revival across North America, established a major evangelical center in Los Angeles, and changed the lives of countless individuals around the world.</p>

<h3>Early Life and Dramatic Conversion</h3>
<p>Born Aimee Elizabeth Kennedy on October 9, 1890, near Ingersoll, Ontario, Canada, she grew up in a Christian home but began questioning her faith as a teenager. At age 17, she attended a Pentecostal revival meeting led by Robert Semple, a young Irish evangelist.</p>

<div class="scripture-box">"Oh, God‚Ä¶ if there be a God‚Ä¶ reveal yourself to me!" ‚Äî Aimee's desperate prayer at age 17 that would change the course of her life and impact millions.</div>

<p>After three days of fierce internal struggle, Aimee surrendered her life to Christ and was filled with the Holy Spirit. This dramatic conversion set the trajectory for her entire ministry.</p>

<h3>Marriage and Missionary Call</h3>
<p>A year after her conversion, Aimee married Robert Semple in 1908. Together they set sail for China as missionaries in 1910. Tragically, shortly after arriving in Hong Kong, both contracted malaria. Robert died on August 19, 1910, leaving Aimee widowed, pregnant, and penniless in a foreign land at just 19 years old.</p>

<div class="key-point"><strong>Key Moment:</strong> Despite devastating loss, Aimee's faith did not waver. She gave birth to daughter Roberta Star Semple and eventually returned to America, where God would prepare her for even greater ministry.</div>

<h3>The Rise of an Evangelist</h3>
<p>After returning to America and a brief second marriage to Harold McPherson (which produced son Rolf Kennedy McPherson), Aimee felt the irresistible call to evangelism. In 1915, she began traveling ministry.</p>

<p>In October 1918, she embarked on her famous <strong>Transcontinental Gospel Car Tour</strong>, driving nearly 6,000 miles in a maroon Oldsmobile from the East Coast to Los Angeles. This journey marked the beginning of her national ministry.</p>

<h3>Extraordinary Ministry</h3>
<p>Aimee rented large auditoriums to accommodate the vast crowds that came to hear her. At one event in San Diego, the National Guard had to be called to control a crowd of more than 30,000 people. People would wait in line for hours, even overnight, to hear "Sister McPherson" preach and pray.</p>

<h3>Miraculous Healings</h3>
<p>During her revivals, people were regularly healed by God from illnesses and infirmities. The American Medical Association launched an investigation in 1921 and found the healings were <strong>"genuine, beneficial and wonderful."</strong></p>

<h3>Ministry Innovations</h3>
<ul>
<li><strong>Media Pioneer:</strong> First woman to receive an FCC broadcast license (KFSG, 1924)</li>
<li><strong>Illustrated Sermons:</strong> Created theatrical presentations to communicate biblical truths</li>
<li><strong>Compassion Ministry:</strong> Fed an estimated 1.5 million people during the Great Depression</li>
<li><strong>Racial Inclusion:</strong> Preached to integrated audiences decades before the civil rights movement</li>
<li><strong>Women in Ministry:</strong> Trained and ordained both men and women equally at L.I.F.E. Bible College</li>
</ul>

<h3>Death and Legacy</h3>
<p>On September 27, 1944, Aimee preached her final sermon in Oakland, California‚Äîthe same city where she had received the "Foursquare Gospel" revelation 22 years earlier. She died that night from an accidental overdose of sleeping medication. She was 53 years old.</p>

<p>But the movement she started survived and thrived. Her son Rolf succeeded her as president and led Foursquare for 44 years. Today, The Foursquare Church ministers in over 150 nations with millions of members carrying forward Sister Aimee's passion for Jesus Christ‚Äîthe Savior, Baptizer with the Holy Spirit, Healer, and Soon-Coming King.</p>`,
        studyGuide: {
          objectives: [
            'Describe the key events in Aimee Semple McPherson\'s life from birth to conversion',
            'Explain how personal tragedy shaped her ministry calling',
            'Identify at least five ministry innovations she pioneered',
            'Connect her legacy to the modern Foursquare movement',
            'Articulate the significance of the AMA investigation findings'
          ],
          keyTerms: [
            {term: 'Pentecostal Revival', def: 'A spiritual movement emphasizing baptism in the Holy Spirit with evidence of speaking in tongues'},
            {term: 'Transcontinental Gospel Car Tour', def: 'Aimee\'s 1918 cross-country evangelistic journey covering nearly 6,000 miles'},
            {term: 'KFSG Radio', def: '"Kall Four Square Gospel" - the third radio station in Los Angeles, launched 1924'},
            {term: 'Illustrated Sermons', def: 'Theatrical presentations using costumes, sets, and drama to teach biblical truths'},
            {term: 'Angelus Temple', def: 'The 5,300-seat church headquarters in Los Angeles, opened January 1, 1923'},
            {term: 'L.I.F.E. Bible College', def: 'Lighthouse of International Foursquare Evangelism - training school founded 1923'}
          ],
          keyScriptures: ['Acts 1:8', 'Mark 16:15-18', 'Matthew 28:19-20', 'Isaiah 61:1-3'],
          sections: [
            {title: '1. Early Life (1890-1907)', content: '<p>Aimee Elizabeth Kennedy was born October 9, 1890, near Ingersoll, Ontario, Canada. Her mother Minnie was a Salvation Army worker who dedicated baby Aimee to God\'s service. Growing up, Aimee was bright and theatrical, winning oratory contests. However, as a teenager, she began questioning her faith after exposure to evolutionary theory at school.</p><div class="discussion-q"><strong>Discussion:</strong> How might Aimee\'s early theatrical talents have prepared her for innovative ministry methods later?</div>'},
            {title: '2. Dramatic Conversion (1907-1908)', content: '<p>At age 17, Aimee attended a Pentecostal revival where Robert Semple preached. Initially skeptical, she wrestled with God for three days. Her desperate prayer‚Äî"Oh God, if there be a God, reveal yourself to me!"‚Äîwas dramatically answered. She was converted and filled with the Holy Spirit, speaking in tongues.</p><div class="discussion-q"><strong>Reflection:</strong> What does Aimee\'s honest questioning teach us about authentic faith journeys?</div>'},
            {title: '3. Marriage and Missionary Tragedy (1908-1910)', content: '<p>Aimee married Robert Semple in 1908. Together they sailed for China as missionaries in 1910. Shortly after arriving in Hong Kong, both contracted malaria. Robert died August 19, 1910, leaving 19-year-old Aimee widowed, pregnant, and penniless in a foreign land. She gave birth to daughter Roberta Star Semple one month later.</p><div class="discussion-q"><strong>Application:</strong> How does God use our deepest pain to prepare us for greater ministry?</div>'},
            {title: '4. Years of Preparation (1910-1918)', content: '<p>Returning to America, Aimee briefly married Harold McPherson (1912), giving birth to son Rolf Kennedy McPherson (1913). During these years she struggled between domestic life and the burning call to preach. By 1915, she could no longer resist and began itinerant evangelism, eventually separating from Harold.</p>'},
            {title: '5. Rise to National Prominence (1918-1923)', content: '<p>The October 1918 Transcontinental Gospel Car Tour launched Aimee\'s national ministry. Driving nearly 6,000 miles with her mother and children, she preached across America. By 1919, crowds exceeded venue capacities everywhere. The 1920 Washington D.C. revival saw 50,000+ attendees. The 1921 AMA investigation verified healings as "genuine, beneficial and wonderful."</p>'},
            {title: '6. Ministry Innovations', content: '<p>Aimee pioneered multiple ministry innovations: (1) First woman with FCC broadcast license - KFSG launched 1924; (2) Illustrated sermons using theatrical presentation; (3) Massive compassion ministry feeding 1.5 million during Depression; (4) Racial integration decades before civil rights; (5) Training both men and women equally for ministry at L.I.F.E. Bible College.</p>'},
            {title: '7. Death and Lasting Legacy (1944-Present)', content: '<p>Aimee died September 27, 1944, in Oakland‚Äîthe same city where she received the Foursquare revelation in 1922. Her son Rolf succeeded her, leading Foursquare for 44 years. Today, The Foursquare Church operates in 150+ nations with millions of members, continuing Sister Aimee\'s vision of Jesus as Savior, Baptizer, Healer, and Coming King.</p><div class="discussion-q"><strong>Legacy Question:</strong> Which of Aimee\'s innovations do you see continuing in churches today?</div>'}
          ]
        },
        quizzes: [
          {q:'When and where was Aimee Semple McPherson born?', options:['October 9, 1890, near Ingersoll, Ontario, Canada','September 27, 1894, Los Angeles, California','January 1, 1890, London, England','March 15, 1888, New York City'], correct:0, explanation:'Aimee Elizabeth Kennedy was born October 9, 1890, near Ingersoll, Ontario, Canada.', difficulty:'easy'},
          {q:'Who led the revival meeting where Aimee was converted?', options:['Billy Sunday','Harold McPherson','Robert Semple','Charles Finney'], correct:2, explanation:'Robert Semple was the young Irish Pentecostal evangelist who led the revival. Aimee later married him.', difficulty:'easy'},
          {q:'How long did Aimee wrestle with God before her conversion?', options:['One night','Three days','One week','One month'], correct:1, explanation:'Aimee struggled internally for three days before surrendering to Christ and being filled with the Holy Spirit.', difficulty:'medium'},
          {q:'What happened to Robert Semple in China?', options:['He started a successful church','He died of malaria','He returned to America alone','He became a translator'], correct:1, explanation:'Robert died of malaria on August 19, 1910, leaving Aimee widowed and pregnant at age 19.', difficulty:'easy'},
          {q:'What was the name of Aimee\'s daughter born in China?', options:['Minnie Kennedy Semple','Roberta Star Semple','Elizabeth Grace Semple','Mary Hope Semple'], correct:1, explanation:'Roberta Star Semple was born one month after Robert\'s death in Hong Kong.', difficulty:'medium'},
          {q:'What was the Transcontinental Gospel Car Tour?', options:['A series of tent revivals','A 6,000-mile cross-country evangelistic journey in 1918','A radio broadcast series','A book tour'], correct:1, explanation:'In October 1918, Aimee drove nearly 6,000 miles from the East Coast to Los Angeles in a maroon Oldsmobile, preaching along the way.', difficulty:'medium'},
          {q:'What did the American Medical Association conclude about Aimee\'s healings in 1921?', options:['They were fraudulent','They were psychological','They were genuine, beneficial and wonderful','They needed more study'], correct:2, explanation:'The AMA investigation found the healings were "genuine, beneficial and wonderful."', difficulty:'medium'},
          {q:'What does KFSG stand for?', options:['Keep Faith Strong in God','Kall Four Square Gospel','Kingdom Foursquare Glory','Knowledge Faith Spirit Grace'], correct:1, explanation:'KFSG stands for "Kall Four Square Gospel" - launched in 1924 as the third radio station in Los Angeles.', difficulty:'medium'},
          {q:'What was historic about Aimee\'s FCC broadcast license?', options:['It was the first ever issued','She was the first woman to receive one','It was the most powerful station','It was free'], correct:1, explanation:'Aimee was the first woman ever to receive an FCC broadcast license.', difficulty:'medium'},
          {q:'How many people did Angelus Temple\'s commissary feed during the Great Depression?', options:['About 50,000','About 500,000','About 1.5 million','About 3 million'], correct:2, explanation:'The commissary ministry fed an estimated 1.5 million people during the Depression years.', difficulty:'medium'},
          {q:'What was L.I.F.E. Bible College?', options:['A correspondence school','Lighthouse of International Foursquare Evangelism - a ministry training school','A secular university partnership','A children\'s program'], correct:1, explanation:'L.I.F.E. stood for Lighthouse of International Foursquare Evangelism, founded in 1923 to train ministers.', difficulty:'medium'},
          {q:'What was significant about who L.I.F.E. Bible College trained?', options:['Only men were admitted','Only women were admitted','Both men and women were trained equally for ministry','Only married couples'], correct:2, explanation:'Aimee trained and ordained both men and women equally, revolutionary for her time.', difficulty:'hard'},
          {q:'When did Aimee die?', options:['January 1, 1950','September 27, 1944','December 25, 1940','October 9, 1948'], correct:1, explanation:'Aimee died September 27, 1944, in Oakland, California, after preaching her final sermon.', difficulty:'easy'},
          {q:'What is significant about the location of Aimee\'s final sermon?', options:['It was her birthplace','It was where she received the Foursquare revelation 22 years earlier','It was the largest venue she ever preached in','It was where she was converted'], correct:1, explanation:'Oakland was where Aimee received the "Foursquare Gospel" revelation in 1922‚Äîshe died there 22 years later.', difficulty:'hard'},
          {q:'Who succeeded Aimee as president of Foursquare?', options:['Her daughter Roberta','Her son Rolf Kennedy McPherson','Her mother Minnie Kennedy','Jack Hayford'], correct:1, explanation:'Her son Rolf Kennedy McPherson succeeded her and led Foursquare for 44 years (1944-1988).', difficulty:'medium'},
          {q:'How many nations does Foursquare currently minister in?', options:['About 50','About 100','Over 150','Over 200'], correct:2, explanation:'Today, The Foursquare Church ministers in over 150 nations worldwide.', difficulty:'easy'},
          {q:'What four aspects of Jesus does the Foursquare Gospel emphasize?', options:['Teacher, Prophet, Priest, King','Creator, Sustainer, Redeemer, Judge','Savior, Baptizer with Holy Spirit, Healer, Soon-Coming King','Lord, Master, Friend, Shepherd'], correct:2, explanation:'The Foursquare Gospel presents Jesus as Savior, Baptizer with the Holy Spirit, Healer, and Soon-Coming King.', difficulty:'easy'},
          {q:'How old was Aimee when she was widowed in China?', options:['17','19','21','25'], correct:1, explanation:'Aimee was just 19 years old when Robert died, leaving her widowed and pregnant in Hong Kong.', difficulty:'easy'},
          {q:'What role did Aimee\'s mother Minnie Kennedy play?', options:['She opposed Aimee\'s ministry','She was a Salvation Army worker who dedicated Aimee to God','She never supported Aimee','She started her own denomination'], correct:1, explanation:'Minnie Kennedy was a Salvation Army worker who dedicated baby Aimee to God\'s service and later helped manage Angelus Temple.', difficulty:'medium'},
          {q:'What made Aimee\'s approach to racial integration significant?', options:['She followed the norms of her day','She preached to integrated audiences decades before the civil rights movement','She only preached to certain groups','She avoided the issue entirely'], correct:1, explanation:'Aimee preached to integrated audiences decades before the civil rights movement, which was revolutionary for her era.', difficulty:'hard'}
        ]
      }
    ]
  },
  {
    id: 'identity', name: 'Identity', icon: '‚ú®', color: 'from-purple-500 to-violet-600', desc: 'What makes Foursquare distinctive',
    chapters: [
      {
        id: 'identity-1', title: 'The Foursquare Gospel: Our Name & Message',
        summary: 'Understand the powerful biblical vision that gave Foursquare its name‚Äîfour faces from Ezekiel representing Jesus as Savior, Baptizer, Healer, and Coming King.',
        reading: `<h2>The Origin of the Foursquare Name</h2>
<p>The name "Foursquare Gospel" came to Aimee Semple McPherson during a revival in Oakland, California in July 1922. It wasn't a name she invented‚Äîit was a revelation she received while preaching on the vision of Ezekiel.</p>

<div class="scripture-box">"Jesus Christ is the same yesterday, today, and forever." ‚Äî Hebrews 13:8 (The foundational Scripture of the Foursquare Gospel)</div>

<h3>The Vision of Ezekiel</h3>
<p>During the Oakland revival, Aimee was preaching on Ezekiel chapter 1, which describes the prophet's vision of four living creatures. Each creature had four faces: the face of a man, the face of a lion, the face of an ox, and the face of an eagle (Ezekiel 1:10).</p>

<p>As she preached, suddenly the significance struck her‚Äîshe saw a complete picture of Christ's ministry in these four faces!</p>

<div class="key-point"><strong>The Revelation:</strong> "Why‚Äîwhy, it's the Foursquare Gospel! The Foursquare Gospel!" burst from Aimee's heart as waves of praise and understanding rocked the audience.</div>

<h3>The Four Faces of Jesus</h3>

<p><strong>1. The Face of a MAN ‚Äî Jesus the SAVIOR</strong></p>
<p>Jesus came as a man to save humanity. He took on human flesh to redeem fallen mankind. "For the Son of Man has come to seek and to save that which was lost" (Luke 19:10). As the perfect man, Jesus lived a sinless life and offered Himself as the sacrifice for our sins.</p>

<p><strong>2. The Face of a LION ‚Äî Jesus the BAPTIZER with the Holy Spirit</strong></p>
<p>The lion represents royalty and power. Jesus, the Lion of the tribe of Judah, baptizes believers with the Holy Spirit and fire. "He will baptize you with the Holy Spirit and fire" (Matthew 3:11). This baptism empowers believers for witness and service.</p>

<p><strong>3. The Face of an OX ‚Äî Jesus the HEALER</strong></p>
<p>The ox was the animal of sacrifice and burden-bearing. Jesus bore our sicknesses and carried our diseases. "By His stripes we are healed" (Isaiah 53:5). Divine healing is provided for in the atonement of Christ.</p>

<p><strong>4. The Face of an EAGLE ‚Äî Jesus the SOON-COMING KING</strong></p>
<p>The eagle soars above all, representing the heavenly realm. Jesus is coming again‚Äîpersonally, visibly, and triumphantly! "For the Lord Himself will descend from heaven with a shout, with the voice of an archangel, and with the trumpet of God" (1 Thessalonians 4:16-17).</p>

<h3>The Unchanging Christ</h3>
<p>The foundation of the Foursquare Gospel is Hebrews 13:8: "Jesus Christ is the same yesterday, today, and forever." The Jesus who saved, baptized, healed, and promised to return in the New Testament is the same Jesus today. He hasn't changed His nature, His power, or His promises.</p>`,
        studyGuide: {
          objectives: [
            'Explain the biblical origin of the Foursquare name from Ezekiel 1',
            'Describe each of the four faces and what aspect of Jesus they represent',
            'Connect Hebrews 13:8 to our unchanging message',
            'Articulate why this fourfold message is central to Foursquare identity'
          ],
          keyTerms: [
            {term: 'Foursquare Gospel', def: 'The message of Jesus as Savior, Baptizer with Holy Spirit, Healer, and Coming King'},
            {term: 'Ezekiel\'s Vision', def: 'The prophet\'s vision in Ezekiel 1 of four living creatures with four faces each'},
            {term: 'Four Living Creatures', def: 'Beings in Ezekiel\'s vision with faces of man, lion, ox, and eagle'},
            {term: 'Hebrews 13:8', def: 'Foundational Scripture: "Jesus Christ is the same yesterday, today, and forever"'}
          ],
          keyScriptures: ['Ezekiel 1:4-10', 'Hebrews 13:8', 'Luke 19:10', 'Matthew 3:11', 'Isaiah 53:5', '1 Thessalonians 4:16-17'],
          sections: [
            {title: '1. The Oakland Revelation (1922)', content: '<p>During a revival in Oakland, California in July 1922, Aimee Semple McPherson was preaching on Ezekiel chapter 1. As she described the four faces of the living creatures, she suddenly saw a complete picture of Christ\'s ministry. "The Foursquare Gospel!" burst from her heart.</p><div class="discussion-q"><strong>Reflection:</strong> Why do you think God chose to reveal this message through an Old Testament vision?</div>'},
            {title: '2. Face of Man ‚Äî SAVIOR', content: '<p>Jesus became fully human to save humanity. Luke 19:10 declares, "The Son of Man has come to seek and to save that which was lost." The face of a man represents Jesus\' incarnation‚ÄîGod becoming flesh to redeem fallen mankind through His perfect life and sacrificial death.</p>'},
            {title: '3. Face of Lion ‚Äî BAPTIZER', content: '<p>The lion represents royalty and power. As the Lion of Judah (Revelation 5:5), Jesus baptizes believers with the Holy Spirit and fire (Matthew 3:11). This baptism empowers believers for witness (Acts 1:8) with the initial evidence of speaking in tongues (Acts 2:4).</p>'},
            {title: '4. Face of Ox ‚Äî HEALER', content: '<p>The ox was the animal of sacrifice and burden-bearing. Isaiah 53:4-5 declares Jesus "bore our griefs and carried our sorrows" and "by His stripes we are healed." Divine healing is provided in the atonement‚ÄîJesus paid for our physical healing on the cross.</p>'},
            {title: '5. Face of Eagle ‚Äî COMING KING', content: '<p>The eagle soars above all earthly things. Jesus will return personally, visibly, and triumphantly from heaven (1 Thessalonians 4:16-17). The blessed hope of Christ\'s return motivates holy living and urgent evangelism.</p>'},
            {title: '6. The Unchanging Foundation', content: '<p>Hebrews 13:8 anchors the Foursquare message: "Jesus Christ is the same yesterday, today, and forever." The Jesus of the Gospels who saved, baptized with the Spirit, healed the sick, and promised to return is the same Jesus today. His nature, power, and promises remain unchanged.</p><div class="discussion-q"><strong>Application:</strong> How does the unchanging nature of Christ give you confidence in prayer and ministry?</div>'}
          ]
        },
        quizzes: [
          {q:'Where and when did Aimee receive the "Foursquare Gospel" revelation?', options:['Los Angeles, 1923','Oakland, California, July 1922','China, 1910','Toronto, 1918'], correct:1, explanation:'The revelation came during a revival in Oakland, California in July 1922.', difficulty:'easy'},
          {q:'What Scripture was Aimee preaching on when she received the revelation?', options:['Revelation 4','Isaiah 6','Ezekiel 1','Daniel 7'], correct:2, explanation:'She was preaching on Ezekiel chapter 1, which describes the four living creatures.', difficulty:'medium'},
          {q:'What is the foundational Scripture for the Foursquare Gospel?', options:['John 3:16','Romans 8:28','Hebrews 13:8','Acts 2:38'], correct:2, explanation:'Hebrews 13:8: "Jesus Christ is the same yesterday, today, and forever."', difficulty:'easy'},
          {q:'The face of a MAN represents Jesus as?', options:['Healer','Savior','Baptizer','Coming King'], correct:1, explanation:'The face of a man represents Jesus the Savior who became human to save humanity.', difficulty:'easy'},
          {q:'The face of a LION represents Jesus as?', options:['Savior','Healer','Baptizer with the Holy Spirit','Coming King'], correct:2, explanation:'The lion represents royalty and power‚ÄîJesus the Baptizer with the Holy Spirit.', difficulty:'easy'},
          {q:'The face of an OX represents Jesus as?', options:['Savior','Healer','Baptizer','Coming King'], correct:1, explanation:'The ox was the burden-bearing sacrifice animal‚ÄîJesus the Healer who bore our sicknesses.', difficulty:'easy'},
          {q:'The face of an EAGLE represents Jesus as?', options:['Savior','Healer','Baptizer','Soon-Coming King'], correct:3, explanation:'The eagle soars above all‚ÄîJesus the Soon-Coming King returning from heaven.', difficulty:'easy'},
          {q:'Which Scripture supports Jesus as Savior (face of man)?', options:['Matthew 3:11','Luke 19:10','Isaiah 53:5','1 Thessalonians 4:16'], correct:1, explanation:'Luke 19:10: "The Son of Man has come to seek and to save that which was lost."', difficulty:'medium'},
          {q:'Which Scripture supports Jesus as Healer (face of ox)?', options:['Matthew 3:11','Luke 19:10','Isaiah 53:5','1 Thessalonians 4:16'], correct:2, explanation:'Isaiah 53:5: "By His stripes we are healed."', difficulty:'medium'},
          {q:'What does "Foursquare" specifically refer to?', options:['The shape of Angelus Temple','The four Gospels','The four faces in Ezekiel\'s vision representing Christ','Four church departments'], correct:2, explanation:'Foursquare refers to the four faces representing Jesus as Savior, Baptizer, Healer, and Coming King.', difficulty:'medium'}
        ]
      }
    ]
  },
  {
    id: 'doctrine', name: 'Doctrine', icon: 'üìñ', color: 'from-blue-500 to-indigo-600', desc: 'Core beliefs',
    chapters: [
      {
        id: 'doctrine-1', title: 'The Declaration of Faith',
        summary: 'Study the 22 statements that define Foursquare\'s core beliefs, compiled by Aimee Semple McPherson.',
        reading: `<h2>The Declaration of Faith</h2>
<p>The Declaration of Faith contains 22 statements compiled by Aimee Semple McPherson that articulate what Foursquare believes. These statements are rooted in Scripture and define our doctrinal foundations.</p>

<h3>Core Doctrinal Areas</h3>

<p><strong>Scripture (Statement 1):</strong> The Bible is verbally inspired by God and without error in the original manuscripts. It is the supreme authority for faith and practice.</p>

<p><strong>The Trinity (Statement 2):</strong> There is one God eternally existing in three persons‚ÄîFather, Son, and Holy Spirit‚Äîcoequal and coeternal.</p>

<p><strong>Humanity and Sin (Statements 3-4):</strong> Humans were created in God's image but fell through sin. All have sinned and need salvation.</p>

<p><strong>Salvation (Statements 5-9):</strong> Salvation is by grace through faith in Jesus Christ, not by works. It includes repentance, new birth, and justification.</p>

<p><strong>The Holy Spirit (Statements 10-13):</strong> The baptism with the Holy Spirit is subsequent to salvation with the initial evidence of speaking in tongues. Believers should pursue the Spirit-filled life and exercise spiritual gifts.</p>

<p><strong>Divine Healing (Statement 14):</strong> Healing of the body is provided for in the atonement of Christ and is available to believers today.</p>

<p><strong>Second Coming (Statement 15):</strong> Jesus Christ will return personally, visibly, and premillennially.</p>

<p><strong>Additional Statements (16-22):</strong> Cover church government, Christian living, tithing, civil government, final judgment, heaven, and hell.</p>`,
        studyGuide: {
          objectives: ['Know the purpose and origin of the 22 statements', 'Understand the key doctrinal positions', 'Explain the Foursquare position on Spirit baptism'],
          keyTerms: [
            {term: 'Declaration of Faith', def: 'The 22 doctrinal statements defining Foursquare beliefs'},
            {term: 'Verbal Inspiration', def: 'The belief that the very words of Scripture are God-breathed'},
            {term: 'Initial Evidence', def: 'Speaking in tongues as the first sign of Spirit baptism'},
            {term: 'Premillennial', def: 'The belief that Christ returns before the thousand-year reign'}
          ],
          keyScriptures: ['2 Timothy 3:16-17', 'Acts 2:4', 'Isaiah 53:5', '1 Thessalonians 4:16-17'],
          sections: [
            {title: 'Scripture & God', content: '<p>The Declaration affirms: (1) Scripture is verbally inspired and inerrant in the originals; (2) God exists eternally as Trinity‚ÄîFather, Son, and Holy Spirit.</p>'},
            {title: 'Salvation', content: '<p>Salvation is by grace through faith alone (Ephesians 2:8-9). It includes repentance, new birth, and justification. Good works are evidence of, not means to, salvation.</p>'},
            {title: 'Holy Spirit Baptism', content: '<p>Spirit baptism is subsequent to salvation with initial evidence of speaking in tongues (Acts 2:4). This empowers believers for witness and service.</p>'},
            {title: 'Divine Healing', content: '<p>Physical healing is provided in Christ\'s atonement (Isaiah 53:5). While not guaranteed in timing, healing is available through faith and prayer.</p>'}
          ]
        },
        quizzes: [
          {q:'How many statements are in the Declaration of Faith?', options:['12','18','22','28'], correct:2, explanation:'There are 22 statements in the Declaration of Faith.', difficulty:'easy'},
          {q:'What does Foursquare believe about the Bible?', options:['Contains God\'s Word among human writings','Verbally inspired and without error in the originals','A good moral guide','One of many holy books'], correct:1, explanation:'The Declaration affirms the Bible is verbally inspired and without error in the original manuscripts.', difficulty:'medium'},
          {q:'What is the initial evidence of Spirit baptism according to Foursquare?', options:['Deep joy','Physical manifestations','Speaking in tongues','Prophesying'], correct:2, explanation:'Speaking in tongues as the Spirit gives utterance is the initial evidence.', difficulty:'easy'},
          {q:'What view does Foursquare hold about Christ\'s return?', options:['Postmillennial','Amillennial','Premillennial','Preterist'], correct:2, explanation:'Foursquare holds a premillennial view‚ÄîChrist returns before the thousand-year reign.', difficulty:'medium'},
          {q:'According to the Declaration, how is salvation received?', options:['By good works','By baptism','By grace through faith','By church membership'], correct:2, explanation:'Salvation is by grace through faith in Jesus Christ, not by works.', difficulty:'easy'}
        ]
      }
    ]
  },
  {
    id: 'polity', name: 'Polity', icon: '‚öñÔ∏è', color: 'from-emerald-500 to-teal-600', desc: 'Church governance',
    chapters: [
      {
        id: 'polity-1', title: 'Foursquare Church Government',
        summary: 'Understand Foursquare\'s unique modified episcopal structure that balances accountability with local autonomy.',
        reading: `<h2>How Foursquare Is Governed</h2>
<p>The Foursquare Church operates under a <strong>modified episcopal</strong> form of government that combines denominational oversight with significant local church autonomy.</p>

<h3>Levels of Government</h3>

<p><strong>1. The Convention:</strong> The highest governing body. All credentialed ministers and elected church delegates gather annually to vote on bylaws, elect Board members, and conduct denominational business.</p>

<p><strong>2. Board of Directors:</strong> Provides oversight between conventions. Includes committees for Bylaws, Finance, Governance, Doctrine, Credentials, and more.</p>

<p><strong>3. The President:</strong> Chief executive officer of Foursquare. Current president: Randy Remington (since 2020). Previous presidents include Aimee Semple McPherson, Rolf McPherson, John Holland, Jack Hayford, and Glenn Burris Jr.</p>

<p><strong>4. Districts:</strong> Six U.S. Districts provide regional oversight: Atlantic, Central, National Hispanic, Northwest, Pacific, and Western. Each has a District Supervisor.</p>

<p><strong>5. Local Churches:</strong> Each church has a Pastor and Church Council. Pastors have significant authority but are accountable to district and national leadership. Properties are held in trust by Foursquare.</p>

<h3>Key Principles</h3>
<ul>
<li>Accountability with autonomy</li>
<li>Shared ownership of property</li>
<li>Credential requirements for ministers</li>
<li>Both men and women may be credentialed and serve in all levels of leadership</li>
</ul>`,
        studyGuide: {
          objectives: ['Describe the five levels of Foursquare government', 'Explain what "modified episcopal" means', 'Identify the six U.S. districts'],
          keyTerms: [
            {term: 'Modified Episcopal', def: 'Church government with denominational oversight but local autonomy'},
            {term: 'Convention', def: 'The highest governing body where ministers and delegates vote'},
            {term: 'District Supervisor', def: 'Regional leader overseeing churches in a geographic area'}
          ],
          keyScriptures: ['Acts 15:1-29', 'Titus 1:5-9', '1 Timothy 3:1-13'],
          sections: [
            {title: 'The Convention', content: '<p>The annual Convention is the highest governing body. Credentialed ministers and church delegates vote on bylaws and elect Board members.</p>'},
            {title: 'The President', content: '<p>The President serves as chief executive. Randy Remington has served since 2020.</p>'},
            {title: 'Districts', content: '<p>Six U.S. Districts: Atlantic, Central, National Hispanic, Northwest, Pacific, and Western.</p>'},
            {title: 'Local Churches', content: '<p>Each church has a Pastor and Church Council with significant local authority while remaining accountable to district leadership.</p>'}
          ]
        },
        quizzes: [
          {q:'What type of government does Foursquare use?', options:['Pure congregational','Pure episcopal','Modified episcopal','Presbyterian'], correct:2, explanation:'Foursquare uses a modified episcopal structure combining oversight with local autonomy.', difficulty:'easy'},
          {q:'What is the highest governing body?', options:['The President','The Board of Directors','The Convention','Local churches'], correct:2, explanation:'The Convention is the highest governing body.', difficulty:'easy'},
          {q:'Who is the current Foursquare President (as of 2020)?', options:['Glenn Burris Jr.','Jack Hayford','Randy Remington','Rolf McPherson'], correct:2, explanation:'Randy Remington has served as President since 2020.', difficulty:'medium'},
          {q:'How many U.S. Districts are there?', options:['4','6','8','12'], correct:1, explanation:'There are six U.S. Districts.', difficulty:'easy'}
        ]
      }
    ]
  },
  {
    id: 'practice', name: 'Ministry Practice', icon: 'üôè', color: 'from-pink-500 to-rose-600', desc: 'Ordinances & Christian living',
    chapters: [
      {
        id: 'practice-1', title: 'The Ordinances & Spirit-Filled Living',
        summary: 'Learn about water baptism, the Lord\'s Supper, Spirit baptism, and walking in the gifts of the Spirit.',
        reading: `<h2>The Two Ordinances</h2>

<h3>Water Baptism</h3>
<p>Water baptism is by <strong>immersion</strong> in the name of the Father, Son, and Holy Spirit. It symbolizes our identification with Christ in His death, burial, and resurrection (Romans 6:3-4). Baptism is for believers only and does not save‚Äîit is an outward testimony of an inward transformation.</p>

<h3>The Lord's Supper (Communion)</h3>
<p>The bread represents Christ's body broken for us; the cup represents His blood shed for the remission of sins. Communion is a memorial (remembering Christ's sacrifice), a proclamation (proclaiming His death until He comes), and an examination (examining our hearts before partaking).</p>

<h2>The Baptism with the Holy Spirit</h2>
<p>Spirit baptism is a distinct experience <strong>subsequent to salvation</strong>. The initial evidence is speaking in other tongues as the Spirit gives utterance (Acts 2:4). This baptism provides power for witnessing (Acts 1:8) and is available to all believers.</p>

<h2>The Gifts of the Spirit</h2>
<p>All nine gifts from 1 Corinthians 12 operate today:</p>
<ul>
<li><strong>Revelation Gifts:</strong> Word of wisdom, word of knowledge, discerning of spirits</li>
<li><strong>Power Gifts:</strong> Faith, gifts of healing, working of miracles</li>
<li><strong>Vocal Gifts:</strong> Prophecy, tongues, interpretation of tongues</li>
</ul>`,
        studyGuide: {
          objectives: ['Explain the two ordinances and their meaning', 'Distinguish Spirit baptism from salvation', 'List the nine spiritual gifts'],
          keyTerms: [
            {term: 'Ordinance', def: 'A commanded practice that symbolizes spiritual truth (baptism, communion)'},
            {term: 'Immersion', def: 'Baptism by fully submerging in water'},
            {term: 'Initial Evidence', def: 'Speaking in tongues as the first sign of Spirit baptism'}
          ],
          keyScriptures: ['Romans 6:3-4', '1 Corinthians 11:23-26', 'Acts 1:8', 'Acts 2:4', '1 Corinthians 12:4-11'],
          sections: [
            {title: 'Water Baptism', content: '<p>By immersion, symbolizing death, burial, and resurrection with Christ. For believers only; does not save but testifies to salvation already received.</p>'},
            {title: 'Lord\'s Supper', content: '<p>Bread = Christ\'s body. Cup = His blood. Memorial, proclamation, and examination.</p>'},
            {title: 'Spirit Baptism', content: '<p>Subsequent to salvation. Initial evidence: speaking in tongues. Provides power for witnessing.</p>'},
            {title: 'Spiritual Gifts', content: '<p>Nine gifts in three categories: Revelation (wisdom, knowledge, discernment), Power (faith, healing, miracles), Vocal (prophecy, tongues, interpretation).</p>'}
          ]
        },
        quizzes: [
          {q:'How many ordinances does Foursquare observe?', options:['1','2','5','7'], correct:1, explanation:'Two ordinances: Water Baptism and the Lord\'s Supper.', difficulty:'easy'},
          {q:'How is baptism performed in Foursquare?', options:['Sprinkling','Pouring','Immersion','Any method'], correct:2, explanation:'Baptism is by immersion, symbolizing burial and resurrection with Christ.', difficulty:'easy'},
          {q:'When does Spirit baptism occur relative to salvation?', options:['Before salvation','At the moment of salvation','Subsequent to (after) salvation','Never'], correct:2, explanation:'Spirit baptism is subsequent to salvation‚Äîa distinct experience after being saved.', difficulty:'medium'},
          {q:'What is the initial evidence of Spirit baptism?', options:['Deep peace','Physical manifestations','Speaking in tongues','Prophesying'], correct:2, explanation:'Speaking in tongues as the Spirit gives utterance (Acts 2:4).', difficulty:'easy'},
          {q:'How many spiritual gifts are listed in 1 Corinthians 12?', options:['7','9','12','15'], correct:1, explanation:'Nine spiritual gifts are listed in 1 Corinthians 12.', difficulty:'easy'}
        ]
      }
    ]
  }
];

// ========== REQUIRED BOOKS ==========
var BOOKS = [
  {
    id: 'fopt', name: 'Foundations of Pentecostal Theology', icon: 'üìö', color: 'from-indigo-500 to-purple-600', desc: 'Complete Textbook',
    chapters: [
      {
        id: 'ch1', num: 1, title: 'The Doctrine of Scripture', hasFullText: true,
        summary: 'Explore bibliology‚Äîthe doctrine of Scripture including its inspiration, inerrancy, canonization, and transmission to us today.',
        studyGuide: {
          objectives: [
            'Explain the meaning and significance of biblical inspiration',
            'Distinguish between verbal plenary inspiration and other theories',
            'Describe how the Old and New Testament canons were formed',
            'Identify the major ancient manuscripts and their significance',
            'Trace the history of the English Bible'
          ],
          keyTerms: [
            {term: 'Bibliology', def: 'The study of the doctrine of Scripture'},
            {term: 'Inspiration', def: 'God-breathed‚Äîthe process by which God directed human authors to write Scripture without error'},
            {term: 'Inerrancy', def: 'The autographs (original manuscripts) contain no errors'},
            {term: 'Canon', def: 'The collection of books recognized as authoritative Scripture'},
            {term: 'Verbal Plenary Inspiration', def: 'Every word of Scripture is God-breathed and without error'},
            {term: 'Autographs', def: 'The original manuscripts written by the biblical authors'},
            {term: 'Septuagint (LXX)', def: 'Greek translation of the Hebrew Old Testament (280-180 BC)'},
            {term: 'Vulgate', def: 'Jerome\'s Latin translation of the Bible (AD 382-405)'},
            {term: 'Textual Criticism', def: 'The study of manuscripts to determine the original text'},
            {term: 'Codex', def: 'An ancient book-form manuscript (vs. scroll)'}
          ],
          keyScriptures: ['2 Timothy 3:16-17', '2 Peter 1:20-21', 'Psalm 119:105', 'Hebrews 4:12', 'John 1:1-14'],
          sections: [
            {title: 'I. The Names of Scripture', content: '<p>The English word "Bible" comes from the Greek <em>biblos</em> meaning "book." Other names include: Scripture/Scriptures (holy writings), Holy Scriptures, Oracles of God, and Word of God‚Äîthe most descriptive name (Mark 7:13; Hebrews 4:12).</p><div class="discussion-q"><strong>Why is "Word of God" the most significant title for Scripture?</strong></div>'},
            {title: 'II. Divisions of Scripture', content: '<p><strong>Two Testaments:</strong> Old Testament (39 books) and New Testament (27 books). "Testament" means covenant.</p><p><strong>Hebrew OT Division:</strong> Law (Torah), Prophets (Nevi\'im), Writings (Ketuvim)‚Äîreferenced by Jesus in Luke 24:44.</p><p><strong>NT Division:</strong> Biographical (Gospels), Historical (Acts), Pedagogical (Epistles), Prophetic (Revelation).</p><p><strong>Chapter/Verse divisions</strong> were added later (chapters by Stephen Langton c.1228; verses by Robert Stephens 1551).</p>'},
            {title: 'III. The Writers of Scripture', content: '<p>The Bible was written by at least 40 authors over 1,500+ years, yet maintains remarkable unity‚Äîevidence of one divine Author. Authors came from diverse backgrounds: kings (David, Solomon), priests (Jeremiah, Ezekiel), physician (Luke), fishermen (Peter, John), shepherds (Moses, Amos), tax collector (Matthew), Pharisee/theologian (Paul), and more.</p>'},
            {title: 'IV. The Canon of Scripture', content: '<p><strong>Canon</strong> (Greek <em>kanon</em>) means "measuring rod" or standard‚Äîbooks worthy of inclusion in Scripture.</p><p><strong>OT Canon:</strong> Complete by time of Christ. Jesus affirmed it (Luke 24:44; 11:51‚Äîfrom Abel to Zechariah = Genesis to 2 Chronicles in Hebrew order).</p><p><strong>NT Canon:</strong> Recognized gradually through the first centuries. Tests for canonicity: (1) Apostolicity, (2) Spiritual content, (3) Doctrinal soundness, (4) Universal usage, (5) Divine inspiration.</p><p><strong>Apocrypha:</strong> 14 books included in Septuagint and Catholic Bible but rejected by Protestants‚Äînot quoted in NT, contain doctrinal inconsistencies.</p>'},
            {title: 'V. The Inerrancy of Scripture', content: '<p><strong>Definition:</strong> The autographs contain no mistakes‚Äîthe Bible is infallible without error.</p><p><strong>The Bible testifies to its own inerrancy:</strong> "All Scripture is God-breathed" (2 Tim 3:16); 3,808 times OT writers claimed to speak God\'s words.</p><p><strong>Jesus confirmed inerrancy</strong>‚ÄîHe referenced specific people/events (Noah, Jonah, Sodom) and never identified errors.</p><p>The Bible is a unique revelation of truth, unchanging, and proven morally/spiritually effective.</p>'},
            {title: 'VI. The Inspiration of Scripture', content: '<p><strong>Inspiration</strong> = God breathed His life into Scripture (2 Tim 3:16). Holy men "spoke as they were moved [borne along] by the Holy Spirit" (2 Pet 1:21).</p><p><strong>Liberal views</strong> see Bible as mix of divine and human error. <strong>Neo-orthodox views</strong> say Bible "becomes" God\'s Word existentially.</p><p><strong>Conservative views:</strong> (1) Verbal dictation‚ÄîGod dictated every word (few hold this); (2) Inspired concept‚Äîthoughts inspired but not words; (3) <strong>Verbal Plenary Inspiration</strong>‚Äîevery word is God-breathed while using human authors\' personalities/styles. This is the Foursquare position.</p>'},
            {title: 'VII. Symbols of Scripture', content: '<p>Scripture uses symbols to describe itself: <strong>Seed</strong> (1 Pet 1:23)‚Äîbrings new life; <strong>Water</strong> (Eph 5:26)‚Äîcleanses; <strong>Lamp/Light</strong> (Ps 119:105)‚Äîguides; <strong>Fire</strong> (Jer 23:29)‚Äîconsumes; <strong>Hammer</strong> (Jer 23:29)‚Äîbreaks; <strong>Sword</strong> (Eph 6:17)‚Äîspiritual weapon; <strong>Milk</strong> (1 Pet 2:2)‚Äînourishes; <strong>Honey</strong> (Ps 119:103)‚Äîsweetness.</p>'},
            {title: 'VIII. The Holy Spirit and Scripture', content: '<p>The Holy Spirit inspired the writing of Scripture (2 Sam 23:2; 2 Pet 1:21). Spirit-filled manifestations must be judged by Scripture‚Äîthe Spirit\'s Word is the "court of appeal" for all spiritual activity. "The prophetic word confirmed" (2 Pet 1:19).</p>'},
            {title: 'IX. How Scripture Came to Us', content: '<p><strong>Writing surfaces:</strong> Stone, clay tablets, wood, leather, papyrus, vellum/parchment.</p><p><strong>Languages:</strong> Hebrew (most OT), Aramaic (portions of Daniel, Ezra), Greek (NT‚ÄîKoine Greek).</p><p><strong>Major Manuscripts:</strong> Sinaitic (Codex Aleph, c.AD 340), Vaticanus (Codex B, c.AD 325-350), Alexandrian (Codex A, c.AD 450), Ephraem (palimpsest), Beza.</p><p><strong>Important Discoveries:</strong> Dead Sea Scrolls (1947)‚Äîconfirmed OT accuracy; Chester Beatty Papyri; John Rylands Fragment.</p>'},
            {title: 'X. Scripture in English', content: '<p><strong>Early translations:</strong> Caedmon (7th c.), Aldhelm (AD 705 Psalms), Venerable Bede (John, AD 735).</p><p><strong>Wycliffe</strong> (1382)‚Äîfirst complete English Bible (from Latin Vulgate).</p><p><strong>Tyndale</strong> (1525)‚Äîfather of English Bible, translated from Greek/Hebrew, martyred 1536.</p><p><strong>Major versions:</strong> Coverdale (1535), Matthew\'s (1537), Great Bible (1539‚Äîfirst authorized), Geneva (1560‚Äîfirst with verses), King James (1611‚Äî"Authorized Version").</p><p><strong>Modern:</strong> ERV (1885), ASV (1901), RSV (1952), NASB (1970), NIV (1978), NKJV (1982).</p><div class="discussion-q"><strong>Why is understanding how we got our Bible important for faith?</strong></div>'}
          ]
        },
        quizzes: [
          {q:'What does the Greek word "biblos" mean?', options:['Holy','Scripture','Book','Inspired'], correct:2, explanation:'Biblos means "book"‚Äîthe root of our word "Bible."', difficulty:'easy'},
          {q:'How many books are in the Old Testament?', options:['27','39','46','66'], correct:1, explanation:'There are 39 books in the Old Testament.', difficulty:'easy'},
          {q:'How many books are in the New Testament?', options:['22','27','31','39'], correct:1, explanation:'There are 27 books in the New Testament.', difficulty:'easy'},
          {q:'What are the three divisions of the Hebrew Old Testament?', options:['History, Poetry, Prophecy','Law, Prophets, Writings','Major Prophets, Minor Prophets, Wisdom','Genesis, Psalms, Isaiah'], correct:1, explanation:'Torah (Law), Nevi\'im (Prophets), and Ketuvim (Writings)‚Äîreferenced by Jesus in Luke 24:44.', difficulty:'medium'},
          {q:'Approximately how many authors wrote the Bible?', options:['12','25','40+','66'], correct:2, explanation:'At least 40 authors wrote the Bible over a span of 1,500+ years.', difficulty:'easy'},
          {q:'What does "canon" mean?', options:['A religious law','A measuring rod or standard','A type of manuscript','An ancient book'], correct:1, explanation:'Canon (Greek kanon) means "measuring rod"‚Äîthe standard for books worthy of Scripture.', difficulty:'medium'},
          {q:'Which test was NOT used to determine a book\'s canonicity?', options:['Apostolicity','Length of the book','Doctrinal soundness','Universal usage'], correct:1, explanation:'Length was not a criterion. The tests were: apostolicity, spiritual content, doctrinal soundness, universal usage, and divine inspiration.', difficulty:'hard'},
          {q:'What is the Septuagint (LXX)?', options:['A Hebrew manuscript','A Greek translation of the OT','The Latin Vulgate','A Dead Sea Scroll'], correct:1, explanation:'The Septuagint is the Greek translation of the Hebrew OT made between 280-180 BC.', difficulty:'medium'},
          {q:'What does "inerrancy" mean regarding Scripture?', options:['The Bible has no copies','The originals contain no errors','All translations are perfect','The Bible cannot be changed'], correct:1, explanation:'Inerrancy means the autographs (original manuscripts) contain no mistakes.', difficulty:'medium'},
          {q:'What is verbal plenary inspiration?', options:['Only the thoughts are inspired','Only the NT is inspired','Every word is God-breathed and without error','God dictated every word verbatim'], correct:2, explanation:'Verbal plenary inspiration holds that every word of Scripture is God-breathed while using human authors.', difficulty:'hard'},
          {q:'According to 2 Timothy 3:16, Scripture is:', options:['Good for teaching','Useful but not authoritative','God-breathed','A human product'], correct:2, explanation:'"All Scripture is God-breathed (theopneustos)" ‚Äî 2 Timothy 3:16.', difficulty:'easy'},
          {q:'How many times did OT writers claim to speak God\'s words?', options:['About 100 times','About 1,000 times','3,808 times','Over 10,000 times'], correct:2, explanation:'OT writers claimed to speak God\'s words 3,808 times.', difficulty:'hard'},
          {q:'Who added chapter divisions to the Bible?', options:['Moses','The apostles','Stephen Langton (c.1228)','King James'], correct:2, explanation:'Stephen Langton, Archbishop of Canterbury, introduced chapter divisions around 1228.', difficulty:'hard'},
          {q:'Who added verse divisions to the New Testament?', options:['Jerome','Robert Stephens (1551)','William Tyndale','The Council of Carthage'], correct:1, explanation:'Robert Stephens added verse divisions in 1551.', difficulty:'hard'},
          {q:'What manuscript discovered at Mount Sinai contains the complete NT?', options:['Vaticanus','Alexandrian','Sinaitic (Codex Aleph)','Ephraem'], correct:2, explanation:'The Sinaitic (Codex Aleph, c.AD 340) is the only ancient manuscript containing the complete NT.', difficulty:'hard'},
          {q:'When were the Dead Sea Scrolls discovered?', options:['1847','1917','1947','1967'], correct:2, explanation:'A Bedouin boy discovered the Dead Sea Scrolls in 1947 near the Dead Sea.', difficulty:'medium'},
          {q:'What did the Dead Sea Scrolls confirm?', options:['The NT is accurate','The OT text accuracy','Jesus was a real person','Daniel wrote in Hebrew'], correct:1, explanation:'The Dead Sea Scrolls confirmed the accuracy of the OT text‚Äîthe Isaiah scroll matched later manuscripts.', difficulty:'medium'},
          {q:'Who produced the first complete English Bible?', options:['William Tyndale','Miles Coverdale','John Wycliffe','King James'], correct:2, explanation:'John Wycliffe produced the first complete English Bible in 1382 (translated from Latin Vulgate).', difficulty:'medium'},
          {q:'Who is called the "father of the English Bible"?', options:['John Wycliffe','William Tyndale','Miles Coverdale','Jerome'], correct:1, explanation:'William Tyndale is the father of the English Bible‚Äîfirst to translate from Greek/Hebrew into English.', difficulty:'medium'},
          {q:'What happened to William Tyndale?', options:['He became Archbishop','He was strangled and burned at the stake','He lived to old age','He became King James\' translator'], correct:1, explanation:'Tyndale was martyred in 1536‚Äîstrangled and burned at the stake.', difficulty:'medium'},
          {q:'What was Tyndale\'s dying prayer?', options:['"Forgive them Father"','"Lord, open the King of England\'s eyes"','"Into your hands I commit my spirit"','"The Word endures forever"'], correct:1, explanation:'"Lord, open the King of England\'s eyes"‚Äîand God answered: later kings authorized the English Bible.', difficulty:'hard'},
          {q:'What was the first "authorized" English Bible?', options:['Tyndale\'s Bible','The Great Bible (1539)','The Geneva Bible','King James Version'], correct:1, explanation:'The Great Bible (1539) was the first Bible officially authorized by a king (Henry VIII).', difficulty:'hard'},
          {q:'What English Bible was the first with verse divisions throughout?', options:['King James Version','The Great Bible','The Geneva Bible (1560)','Tyndale\'s Bible'], correct:2, explanation:'The Geneva Bible (1560) was the first English Bible divided entirely into verses.', difficulty:'hard'},
          {q:'When was the King James Version published?', options:['1525','1582','1611','1769'], correct:2, explanation:'The King James Version was published in 1611.', difficulty:'easy'},
          {q:'What percentage pure is the NT text according to scholars?', options:['About 80%','About 90%','Over 99%','100%'], correct:2, explanation:'Scholars like Westcott, Hort, and Robertson conclude the NT text is over 99% pure.', difficulty:'hard'},
          {q:'The Vulgate is:', options:['A Greek OT translation','Jerome\'s Latin Bible','A Dead Sea Scroll','An English translation'], correct:1, explanation:'The Vulgate is Jerome\'s Latin translation of the Bible (AD 382-405).', difficulty:'medium'},
          {q:'What writing surface was made from animal skins?', options:['Papyrus','Vellum/Parchment','Clay','Stone'], correct:1, explanation:'Vellum (from calves/antelopes) and parchment (from sheep/goats) were made from animal skins.', difficulty:'medium'},
          {q:'What language was most of the Old Testament written in?', options:['Greek','Latin','Hebrew','Aramaic'], correct:2, explanation:'Almost all of the OT was written in Hebrew.', difficulty:'easy'},
          {q:'What language was the New Testament written in?', options:['Hebrew','Latin','Aramaic','Koine Greek'], correct:3, explanation:'The NT was written in Koine Greek‚Äîthe common language of the first century.', difficulty:'easy'},
          {q:'Jesus affirmed the OT canon by reference to martyrs from Abel to:', options:['Daniel','Malachi','Zechariah','John the Baptist'], correct:2, explanation:'Luke 11:51‚Äîfrom Abel (Genesis) to Zechariah (2 Chronicles, last book in Hebrew order).', difficulty:'hard'}
        ]
      },
      {id:'ch2', num:2, title:'The Doctrine of God', hasFullText:true, summary:'Study theology proper‚Äîthe nature, attributes, and works of God, including the Trinity.'},
      {id:'ch3', num:3, title:'The Doctrine of Humankind', hasFullText:true, summary:'Understand anthropology‚Äîhuman nature, creation in God\'s image, and the constitution of humanity.'},
      {id:'ch4', num:4, title:'The Doctrine of Sin', hasFullText:true, summary:'Examine hamartiology‚Äîthe origin, nature, and consequences of sin.'},
      {id:'ch5', num:5, title:'The Doctrine of Salvation', hasFullText:true, summary:'Discover soteriology‚Äîhow God saves through Christ, including justification, sanctification, and glorification.'},
      {id:'ch6', num:6, title:'The Doctrine of the Holy Spirit', hasFullText:true, summary:'Study pneumatology‚Äîthe person and work of the Holy Spirit, including baptism and gifts.'},
      {id:'ch7', num:7, title:'The Doctrine of Divine Healing', hasFullText:true, summary:'Learn about healing in the atonement and its practice in the church today.'},
      {id:'ch8', num:8, title:'The Doctrine of the Church', hasFullText:true, summary:'Explore ecclesiology‚Äîthe nature, mission, government, and ordinances of the church.'},
      {id:'ch9', num:9, title:'The Doctrine of Angels', hasFullText:true, summary:'Study angelology‚Äîangels, Satan, and demons in Scripture.'},
      {id:'ch10', num:10, title:'The Doctrine of Last Things', hasFullText:true, summary:'Discover eschatology‚Äîdeath, resurrection, rapture, tribulation, millennium, and eternal state.'}
    ]
  },
  {id:'aimee-bio', name:'Aimee: Life Story', icon:'üë©', color:'from-rose-400 to-pink-500', desc:'Biography', comingSoon:true, chapters:[]},
  {id:'women-ministry', name:'Women in Ministry', icon:'üë©‚Äçüè´', color:'from-fuchsia-400 to-purple-500', desc:'Biblical position', comingSoon:true, chapters:[]},
  {id:'disciples-nations', name:'Disciples of All Nations', icon:'üåç', color:'from-cyan-400 to-blue-500', desc:'Missions', comingSoon:true, chapters:[]},
  {id:'keystones', name:'Foursquare Keystones', icon:'üîë', color:'from-amber-400 to-orange-500', desc:'Five key areas', comingSoon:true, chapters:[]}
];

// Default study guide for chapters without full study content
function getDefaultStudyGuide(ch) {
  var title = ch.title || 'Chapter';
  return {
    objectives: [
      'Understand the historical and theological context of ' + title,
      'Identify and define key theological terms and concepts',
      'Recognize biblical foundations and scriptural support',
      'Analyze the practical implications for ministry',
      'Apply learned truths to personal faith journey',
      'Prepare to articulate these concepts in licensing interview'
    ],
    keyTerms: [],
    keyScriptures: [],
    sections: [
      {
        title: 'Introduction & Context',
        content: '<p>Welcome to the study guide for <strong>' + title + '</strong>. This comprehensive guide will help you deeply understand and internalize the content of this chapter.</p>' +
          '<div class="key-point"><strong>Study Objectives:</strong><ul><li>Grasp the foundational concepts presented</li><li>Connect theological truths to Scripture</li><li>Prepare for your licensing interview</li></ul></div>' +
          '<p>Before proceeding, ensure you have completed reading the full chapter content. Take your time with each section of this study guide, making notes and reflecting on how each concept applies to your calling.</p>' +
          '<p>The Foursquare Church places great emphasis on ministers who can articulate their beliefs with clarity and biblical grounding. This study guide is designed to help you achieve that goal.</p>'
      },
      {
        title: 'Historical Background',
        content: '<p>Understanding the historical context enriches your grasp of this material. The Foursquare Church was founded on timeless biblical principles that remain relevant today.</p>' +
          '<div class="scripture-box"><strong>Key Historical Points:</strong><p>Consider how the early church fathers, the Reformation, and the Pentecostal revival movements all contributed to our understanding of these truths.</p></div>' +
          '<p>Aimee Semple McPherson founded the Foursquare Church in 1923, but the truths we hold are rooted in Scripture and have been affirmed throughout church history. As you study, consider how these doctrines have been preserved and passed down through generations of faithful believers.</p>' +
          '<p>The theological positions of Foursquare are not innovations but recoveries of biblical Christianity that emphasize the full ministry of Jesus Christ as Savior, Baptizer with the Holy Spirit, Healer, and Soon-Coming King.</p>'
      },
      {
        title: 'Core Theological Concepts',
        content: '<p>This section focuses on the central theological ideas presented in the chapter. Pay careful attention to definitions and distinctions.</p>' +
          '<div class="key-point"><strong>Theological Framework:</strong><p>Foursquare theology is grounded in evangelical orthodoxy while embracing the continuing work of the Holy Spirit. We affirm the authority of Scripture, salvation by grace through faith, and the priesthood of all believers.</p></div>' +
          '<p>Key concepts to master include:</p><ul><li>The relationship between doctrine and practice</li><li>How biblical interpretation shapes our beliefs</li><li>The balance between theological precision and spiritual vitality</li><li>Our distinctive emphasis on the fourfold ministry of Christ</li></ul>' +
          '<p>Take time to write out definitions in your own words. Being able to explain these concepts simply and clearly is essential for effective ministry.</p>'
      },
      {
        title: 'Biblical Foundations',
        content: '<p>Every Foursquare doctrine is built on the foundation of Scripture. This section helps you identify and understand the biblical texts that support the teachings in this chapter.</p>' +
          '<div class="scripture-box"><strong>Scripture Study Method:</strong><p>For each key verse: (1) Read it in context, (2) Identify the main point, (3) Consider how it supports the doctrine, (4) Memorize key references.</p></div>' +
          '<p>The Declaration of Faith states that Scripture is "the divine, supreme and eternal tribunal by whose standards all men, nations, creeds, and motives shall be tried." This means we must always ground our beliefs in biblical truth.</p>' +
          '<p>As you study, create a list of Scripture references that support each major point. Being able to cite chapter and verse demonstrates both your knowledge and your commitment to biblical authority.</p>' +
          '<div class="key-point"><strong>Practice Exercise:</strong><p>Choose three key Scriptures from this chapter and write a brief explanation of how each supports Foursquare teaching.</p></div>'
      },
      {
        title: 'Practical Applications',
        content: '<p>Theology must move from head to heart to hands. This section explores how the truths in this chapter apply to real-life ministry situations.</p>' +
          '<p>Consider these practical dimensions:</p><ul><li><strong>Personal Devotion:</strong> How does this truth affect your prayer life and spiritual disciplines?</li><li><strong>Preaching & Teaching:</strong> How would you communicate this to your congregation?</li><li><strong>Pastoral Care:</strong> How does this doctrine provide comfort or guidance to those you shepherd?</li><li><strong>Evangelism:</strong> How does this truth relate to sharing the Gospel?</li></ul>' +
          '<div class="key-point"><strong>Ministry Scenario:</strong><p>Imagine a church member asks you to explain this topic. How would you answer in a way that is theologically accurate yet accessible?</p></div>' +
          '<p>The best ministers are those who can take deep theological truths and make them understandable and applicable to everyday life. Practice explaining these concepts to friends or family members.</p>'
      },
      {
        title: 'Foursquare Distinctives',
        content: '<p>While Foursquare shares much in common with other evangelical and Pentecostal traditions, we have distinctive emphases worth understanding.</p>' +
          '<div class="key-point"><strong>The Foursquare Gospel:</strong><p>Jesus Christ as Savior, Baptizer with the Holy Spirit, Healer, and Soon-Coming King. This fourfold message is the heart of our identity.</p></div>' +
          '<p>Our distinctives include:</p><ul><li>A balanced approach to the gifts of the Spirit</li><li>Affirmation of women in all levels of ministry leadership</li><li>A connectional structure that provides both accountability and local church freedom</li><li>Commitment to both evangelism and compassion ministry</li><li>A global perspective with indigenous leadership development</li></ul>' +
          '<p>Understanding what makes Foursquare unique helps you articulate why you are pursuing licensing in this movement rather than another.</p>'
      },
      {
        title: 'Common Questions & Answers',
        content: '<p>Licensing panels often ask similar questions. This section prepares you for common inquiries related to this chapter.</p>' +
          '<div class="key-point"><strong>Sample Questions:</strong><ol><li>Can you explain the biblical basis for this doctrine?</li><li>How does this teaching affect your personal ministry?</li><li>What are common misconceptions about this topic?</li><li>How would you teach this to new believers?</li></ol></div>' +
          '<p>Practice answering these questions out loud. Many candidates know the material but struggle to articulate it verbally. Regular practice builds confidence.</p>' +
          '<p>Remember that licensing panels are not trying to trip you up. They want to confirm that you understand and embrace Foursquare beliefs, and that you can communicate them effectively.</p>' +
          '<div class="scripture-box"><strong>Tip:</strong><p>Begin answers with Scripture when possible. This demonstrates that your beliefs are biblically grounded.</p></div>'
      },
      {
        title: 'Study Review & Self-Assessment',
        content: '<p>Before moving to the quiz, take time for self-assessment. Can you:</p>' +
          '<ul><li>Define the key terms from this chapter?</li><li>Cite relevant Scripture references from memory?</li><li>Explain the historical context of these teachings?</li><li>Articulate how these truths apply to ministry?</li><li>Describe what makes the Foursquare perspective distinctive?</li><li>Answer common questions clearly and confidently?</li></ul>' +
          '<div class="key-point"><strong>Final Preparation:</strong><p>Write a one-paragraph summary of this chapter in your own words. This exercise consolidates your learning and prepares you for the quiz.</p></div>' +
          '<p>If you feel uncertain about any area, return to the reading and previous study sections. The goal is not just to pass a quiz but to truly understand and embrace these truths.</p>' +
          '<p>When you are ready, proceed to the quiz to test your knowledge. The quiz contains 50 questions covering all aspects of this chapter.</p>'
      }
    ]
  };
}

// Comprehensive 50-question quiz generator
function getDefaultQuizzes(ch) {
  var title = ch.title || 'this chapter';
  return [
    // Section 1: Basic Comprehension (Questions 1-10)
    {q:'What is the primary purpose of studying ' + title + '?', options:['To pass a test','To understand Foursquare beliefs and prepare for ministry','To fulfill a requirement','To impress the licensing panel'], correct:1, explanation:'Study prepares us for effective ministry by deepening our understanding of biblical truth.', difficulty:'easy'},
    {q:'Have you completed reading the full chapter content?', options:['Yes, completely','Mostly','Partially','Not yet'], correct:0, explanation:'Complete reading is foundational to understanding the material.', difficulty:'easy'},
    {q:'Did you take written notes while studying?', options:['Yes, detailed notes','Some notes','Mental notes only','No notes'], correct:0, explanation:'Written notes improve retention and provide study material for review.', difficulty:'easy'},
    {q:'Why is understanding Foursquare doctrine important for licensing?', options:['It is merely tradition','Ministers must articulate and teach these beliefs','It is optional knowledge','Only senior pastors need this'], correct:1, explanation:'Licensed ministers represent Foursquare and must understand and communicate our beliefs.', difficulty:'easy'},
    {q:'What is the foundation of all Foursquare doctrine?', options:['Church tradition','The Holy Scripture','Human philosophy','Cultural relevance'], correct:1, explanation:'Scripture is the divine, supreme and eternal tribunal for all Foursquare beliefs.', difficulty:'easy'},
    {q:'How should theological knowledge affect ministry practice?', options:['It should remain academic','It should inform and guide all ministry','Practice is separate from doctrine','Theology is only for seminaries'], correct:1, explanation:'Sound doctrine produces sound practice. Theology must move from head to heart to hands.', difficulty:'easy'},
    {q:'What year was the Foursquare Church founded?', options:['1906','1915','1923','1944'], correct:2, explanation:'Aimee Semple McPherson founded the International Church of the Foursquare Gospel in 1923.', difficulty:'easy'},
    {q:'Who founded the Foursquare Church?', options:['Billy Graham','Aimee Semple McPherson','Charles Spurgeon','John Wesley'], correct:1, explanation:'Aimee Semple McPherson founded Foursquare and established Angelus Temple in Los Angeles.', difficulty:'easy'},
    {q:'What does "Foursquare" refer to in our name?', options:['Four founding churches','The shape of our buildings','The fourfold ministry of Christ','Four core practices'], correct:2, explanation:'Foursquare refers to Jesus as Savior, Baptizer, Healer, and Soon-Coming King.', difficulty:'easy'},
    {q:'Where is Foursquare headquarters located?', options:['New York','Chicago','Los Angeles','Dallas'], correct:2, explanation:'Foursquare remains headquartered at Angelus Temple in Los Angeles, California.', difficulty:'easy'},
    
    // Section 2: Theological Understanding (Questions 11-20)
    {q:'What is the relationship between the Old and New Testaments in Foursquare theology?', options:['Only New Testament matters','They contradict each other','Both are inspired Scripture and complement each other','Old Testament is just history'], correct:2, explanation:'Both Testaments are the inspired Word of God and together reveal His plan of redemption.', difficulty:'medium'},
    {q:'How does Foursquare view the authority of Scripture?', options:['One source among many','The supreme authority for faith and practice','Subject to modern reinterpretation','Historically interesting but not binding'], correct:1, explanation:'Scripture is the divine, supreme and eternal tribunal by whose standards all beliefs are measured.', difficulty:'medium'},
    {q:'What is the Foursquare position on the Trinity?', options:['Three separate Gods','One God in three modes','One God eternally existing in three persons','A symbolic concept'], correct:2, explanation:'We believe in one God eternally existing in three persons: Father, Son, and Holy Spirit.', difficulty:'medium'},
    {q:'How is salvation received according to Foursquare belief?', options:['By good works','By grace through faith in Jesus Christ','By church membership','By keeping the law'], correct:1, explanation:'Salvation is wholly through grace, received by faith in Jesus Christ alone.', difficulty:'medium'},
    {q:'What does Foursquare teach about the Baptism of the Holy Spirit?', options:['It is the same as salvation','It is a separate experience empowering believers','It is not for today','It is only for leaders'], correct:1, explanation:'The Baptism of the Holy Spirit is a distinct experience that endues believers with power for witness and service.', difficulty:'medium'},
    {q:'What is the Foursquare view on divine healing?', options:['Healing ended with the apostles','Jesus still heals in answer to believing prayer','Medical care replaces prayer','Healing is guaranteed for all'], correct:1, explanation:'Divine healing is the power of Jesus Christ to heal in answer to believing prayer - He is the same yesterday, today, and forever.', difficulty:'medium'},
    {q:'What does Foursquare believe about the Second Coming?', options:['It is symbolic only','Christ will return personally and imminently','It already happened spiritually','The date can be calculated'], correct:1, explanation:'We believe in the personal, imminent return of Jesus Christ in the clouds of glory.', difficulty:'medium'},
    {q:'What is the purpose of water baptism in Foursquare practice?', options:['To earn salvation','An outward sign of an inward work','A meaningless tradition','Required for church membership only'], correct:1, explanation:'Water baptism is a blessed outward sign of the inward work of salvation, identifying with Christ in death and resurrection.', difficulty:'medium'},
    {q:'How often should communion be celebrated according to Foursquare?', options:['Only at Easter','Never','Regularly as the church determines','Only once in a lifetime'], correct:2, explanation:'The Lords Supper should be celebrated regularly, with the frequency determined by local church practice.', difficulty:'medium'},
    {q:'What is the Foursquare view on speaking in tongues?', options:['It is required for salvation','It is a gift of the Spirit for today','It ceased after the apostolic age','It is demonic'], correct:1, explanation:'Speaking in tongues is one of the gifts of the Spirit, available to believers today.', difficulty:'medium'},
    
    // Section 3: Foursquare Distinctives (Questions 21-30)
    {q:'What is distinctive about Foursquare regarding women in ministry?', options:['Women cannot lead','Women can only teach children','Women are affirmed in all levels of ministry leadership','This is a recent change'], correct:2, explanation:'From our founding by a woman evangelist, Foursquare has affirmed women in all forms of ministry leadership.', difficulty:'medium'},
    {q:'How does Foursquare balance accountability and local church freedom?', options:['Total independence for each church','Total denominational control','A connectional structure with both accountability and freedom','No structure at all'], correct:2, explanation:'Foursquare provides connectional accountability while empowering local churches to contextualize ministry.', difficulty:'medium'},
    {q:'What is the role of the Foursquare Convention?', options:['A social gathering','The chief decision-making body','A missions event only','A worship conference'], correct:1, explanation:'The Foursquare Convention is the chief decision-making body of the movement.', difficulty:'medium'},
    {q:'How are Foursquare ministers licensed?', options:['Self-appointment','Through the credentialing process with panel interview','By online application only','Automatically after training'], correct:1, explanation:'Ministers are licensed through a process that includes training, examination, and panel interview.', difficulty:'medium'},
    {q:'What is unique about Foursquare church property?', options:['Each church owns independently','Property is held in trust for ICFG','There is no church property','The pastor owns everything'], correct:1, explanation:'Foursquare churches hold property in trust for the International Church of the Foursquare Gospel.', difficulty:'medium'},
    {q:'How many countries have Foursquare presence?', options:['About 50','About 100','Over 150','Over 200'], correct:2, explanation:'Foursquare has a presence in over 150 nations worldwide.', difficulty:'medium'},
    {q:'What verse is inscribed behind the pulpit at Angelus Temple?', options:['John 3:16','Hebrews 13:8','Matthew 28:19','Acts 1:8'], correct:1, explanation:'Hebrews 13:8 - "Jesus Christ is the same yesterday, today, and forever" captures our conviction about Christ\'s unchanging ministry.', difficulty:'medium'},
    {q:'What institution trains Foursquare ministers?', options:['Fuller Seminary','Life Pacific University (formerly L.I.F.E.)','Biola University','Azusa Pacific'], correct:1, explanation:'Life Pacific University (formerly L.I.F.E. Bible College) was founded by Aimee in 1923 to train ministers.', difficulty:'medium'},
    {q:'What is KFSG?', options:['A Foursquare conference','The first religious radio station founded by Aimee','A missions organization','A worship album'], correct:1, explanation:'KFSG (Kall FourSquare Gospel) was the radio station Aimee founded in 1924, making her the first woman to preach on radio.', difficulty:'medium'},
    {q:'What ministry did Angelus Temple provide during the Great Depression?', options:['Only worship services','Fed an estimated 1.5 million people','Political advocacy','Closed during the Depression'], correct:1, explanation:'The commissary at Angelus Temple fed approximately 1.5 million people during the Great Depression.', difficulty:'medium'},
    
    // Section 4: Application & Practice (Questions 31-40)
    {q:'How should a Foursquare minister approach someone with questions about healing?', options:['Avoid the topic','Pray with faith while avoiding false promises','Promise guaranteed healing','Refer them elsewhere'], correct:1, explanation:'We pray with faith for healing while acknowledging that God is sovereign and works according to His will.', difficulty:'hard'},
    {q:'What is the proper response when asked about speaking in tongues by a new believer?', options:['Demand they speak in tongues immediately','Explain it is a gift of the Spirit available to all believers','Say it is not important','Discourage the practice'], correct:1, explanation:'We teach that tongues is a biblical gift available to believers, while not making it a requirement for salvation or spirituality.', difficulty:'hard'},
    {q:'How should a Foursquare minister handle doctrinal disagreement?', options:['Leave the denomination','Ignore core beliefs','Work within Foursquare structures with grace and integrity','Publicly criticize leadership'], correct:2, explanation:'Ministers should address concerns through proper channels while maintaining unity and respect.', difficulty:'hard'},
    {q:'What approach should be taken in preaching?', options:['Entertainment only','Biblical exposition with practical application','Academic lecture','Political commentary'], correct:1, explanation:'Effective preaching grounds truth in Scripture and applies it to the lives of hearers.', difficulty:'hard'},
    {q:'How does Foursquare view the relationship between evangelism and compassion?', options:['Only evangelism matters','Only social work matters','Both proclamation and compassion are essential','They should be separate'], correct:2, explanation:'Following Aimees example, Foursquare combines Gospel proclamation with compassion ministry.', difficulty:'hard'},
    {q:'What is the ministers responsibility regarding continuing education?', options:['Training ends at licensing','Lifelong learning is essential','Only required if mandated','Not important after ordination'], correct:1, explanation:'Ministers should pursue ongoing development throughout their ministry career.', difficulty:'hard'},
    {q:'How should a minister approach cultural contextualization?', options:['Ignore culture entirely','Adapt the Gospel message itself','Adapt methods while maintaining biblical truth','Follow American culture only'], correct:2, explanation:'We contextualize ministry methods while maintaining the unchanging truth of Scripture.', difficulty:'hard'},
    {q:'What is the proper understanding of church discipline?', options:['Never needed','Harsh punishment','Redemptive process aimed at restoration','Public shaming'], correct:2, explanation:'Church discipline should be redemptive, seeking restoration while protecting the body.', difficulty:'hard'},
    {q:'How should Foursquare ministers view other denominations?', options:['All others are wrong','Partner with those who share core gospel convictions','Ignore them entirely','Compete against them'], correct:1, explanation:'While distinct, we partner with other believers who share commitment to biblical Christianity.', difficulty:'hard'},
    {q:'What is the role of prayer in Foursquare ministry?', options:['A nice addition','Central to all ministry','Only for personal devotions','Reserved for special occasions'], correct:1, explanation:'Prayer is central to Spirit-empowered ministry and should permeate all we do.', difficulty:'hard'},
    
    // Section 5: Deep Theology & Advanced (Questions 41-50)
    {q:'How does Foursquare understand the inspiration of Scripture?', options:['Human writings only','Dictated word-for-word','God-breathed through human authors','Partially inspired'], correct:2, explanation:'Scripture is God-breathed (inspired) through human authors, fully divine and fully reflecting human personality.', difficulty:'hard'},
    {q:'What is the Foursquare position on the eternal security of the believer?', options:['Once saved, always saved without exception','Believers must maintain faith but God preserves His children','Salvation can be lost by any sin','There is no security'], correct:1, explanation:'Foursquare teaches that genuine believers are kept by Gods power through faith, emphasizing both divine preservation and human responsibility.', difficulty:'hard'},
    {q:'How does Foursquare view the relationship between faith and works?', options:['Works earn salvation','Faith alone saves, and genuine faith produces good works','Works are unnecessary','Faith and works are equal'], correct:1, explanation:'Salvation is by grace through faith alone, but genuine saving faith inevitably produces good works.', difficulty:'hard'},
    {q:'What does Foursquare teach about spiritual warfare?', options:['Satan is not real','Believers have authority in Christ over spiritual forces','Ignore demonic activity','Focus only on demons'], correct:1, explanation:'We acknowledge spiritual warfare and the believers authority in Christ, while maintaining a balanced, Scripture-based approach.', difficulty:'hard'},
    {q:'How should ministers approach the gifts of the Spirit?', options:['Forbid all gifts','Seek all gifts earnestly with biblical order','Focus on tongues only','Gifts are not for today'], correct:1, explanation:'We earnestly desire spiritual gifts while ensuring they operate according to biblical guidelines and for edification.', difficulty:'hard'},
    {q:'What is the proper understanding of sanctification?', options:['Instant sinless perfection','Progressive growth in holiness through the Spirit','Unnecessary for believers','Achieved by human effort'], correct:1, explanation:'Sanctification is a progressive work of the Spirit conforming believers to Christs image throughout life.', difficulty:'hard'},
    {q:'How does Foursquare approach biblical interpretation?', options:['Literal only','Grammatical-historical method considering context and genre','Allegorical only','Personal interpretation without guidelines'], correct:1, explanation:'We use sound hermeneutical principles, considering grammar, history, context, and literary genre.', difficulty:'hard'},
    {q:'What is the Foursquare view of the Church universal?', options:['Only Foursquare churches','All true believers in Christ across denominations','Only one physical organization','There is no universal Church'], correct:1, explanation:'The Church universal consists of all genuine believers in Jesus Christ across all denominations and nations.', difficulty:'hard'},
    {q:'How should Foursquare ministers understand their calling?', options:['A job like any other','A sacred trust and divine appointment','Self-chosen career','Only for the specially talented'], correct:1, explanation:'Ministry is a sacred calling from God, a trust that requires faithfulness and accountability.', difficulty:'hard'},
    {q:'What summarizes the heart of Foursquare mission?', options:['Building large churches','Glorifying God by proclaiming the Gospel and making disciples','Political influence','Preserving tradition'], correct:1, explanation:'Our mission is to glorify God by proclaiming the Gospel of Jesus Christ and making disciples of all nations.', difficulty:'hard'}
  ];
}


// ========== AUTHENTICATION - NEVER CHANGE WITHOUT PERMISSION ==========
// ========== AUTHENTICATION ==========
async function handleLogin() {
  var email = document.getElementById('login-email').value.trim();
  var pw = document.getElementById('login-password').value;
  if (!email || !pw) return showError('Please fill in all fields');
  if (!supabase) return showError('Connecting to server...');
  hideError();
  try {
    var r = await supabase.auth.signInWithPassword({email: email, password: pw});
    if (r.error) throw r.error;
    currentUser = r.data.user;
    await loadProgress();
    showNav('home');
  } catch (e) { showError(e.message); }
}

async function handleRegister() {
  var name = document.getElementById('reg-name').value.trim();
  var email = document.getElementById('reg-email').value.trim();
  var pw = document.getElementById('reg-password').value;
  if (!name || !email || !pw) return showError('Please fill in all fields');
  if (pw.length < 6) return showError('Password must be at least 6 characters');
  if (!supabase) return showError('Connecting to server...');
  hideError();
  try {
    var r = await supabase.auth.signUp({email: email, password: pw, options: {data: {name: name}}});
    if (r.error) throw r.error;
    currentUser = r.data.user;
    userProgress = createDefaultProgress();
    await saveProgress();
    showNav('home');
  } catch (e) { showError(e.message); }
}

async function handleLogout() {
  if (supabase) await supabase.auth.signOut();
  currentUser = null;
  userProgress = null;
  showScreen('login');
}

function checkSession() {
  supabase?.auth.getSession().then(r => {
    if (r.data.session) {
      currentUser = r.data.session.user;
      loadProgress().then(() => showNav('home'));
    }
  });
}

function showError(msg) {
  document.getElementById('login-error').textContent = msg;
  document.getElementById('login-error').classList.remove('hidden');
}
function hideError() {
  document.getElementById('login-error').classList.add('hidden');
}

function createDefaultProgress() {
  var p = {annotations: {highlights: [], notes: [], bookmarks: []}, lastRead: null, recentActivity: [], studyTime: 0};
  DOMAINS.forEach(d => {
    p[d.id] = {};
    d.chapters.forEach(c => { p[d.id][c.id] = {read: false, studied: false, quizScore: 0, lastPage: 1}; });
  });
  BOOKS.forEach(b => {
    if (!b.comingSoon) {
      p[b.id] = {};
      b.chapters.forEach(c => { p[b.id][c.id] = {read: false, studied: false, quizScore: 0, lastPage: 1}; });
    }
  });
  return p;
}

async function loadProgress() {
  try {
    var r = await supabase.from('progress').select('data').eq('user_id', currentUser.id).single();
    userProgress = r.data?.data || createDefaultProgress();
  } catch (e) {
    userProgress = createDefaultProgress();
  }
  if (!userProgress.annotations) userProgress.annotations = {highlights: [], notes: [], bookmarks: []};
  if (!userProgress.recentActivity) userProgress.recentActivity = [];
  annotations = userProgress.annotations;
  recentActivity = userProgress.recentActivity;
}

async function saveProgress() {
  userProgress.annotations = annotations;
  userProgress.recentActivity = recentActivity;
  try {
    await supabase.from('progress').upsert({user_id: currentUser.id, data: userProgress, updated_at: new Date().toISOString()}, {onConflict: 'user_id'});
  } catch (e) { console.error('Save error:', e); }
}

function addRecentActivity(type, title, details) {
  recentActivity.unshift({type: type, title: title, details: details, time: new Date().toISOString()});
  if (recentActivity.length > 10) recentActivity = recentActivity.slice(0, 10);
  saveProgress();
}

// ========== NAVIGATION ==========
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function showNav(nav) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (nav === 'home') { showScreen('home'); renderHome(); }
  else if (nav === 'study') { showScreen('study'); renderStudyList(); }
  else if (nav === 'notes') { showScreen('notes'); filterNotes('all'); }
  else if (nav === 'profile') { showScreen('profile'); renderProfile(); }
}

function toggleSection(id) {
  expandedSections[id] = !expandedSections[id];
  document.getElementById(id + '-content').classList.toggle('expanded', expandedSections[id]);
  document.getElementById(id + '-chevron').style.transform = expandedSections[id] ? 'rotate(180deg)' : '';
}


// ========== HOME SCREEN ==========
function renderHome() {
  var name = currentUser?.user_metadata?.name || currentUser?.email?.split('@')[0] || 'Student';
  document.getElementById('user-name').textContent = name;
  
  // Calculate stats
  var totalItems = 0, doneItems = 0, chaptersRead = 0, chaptersStudied = 0, quizzesPassed = 0;
  [...DOMAINS, ...BOOKS].forEach(cat => {
    if (cat.comingSoon) return;
    cat.chapters?.forEach(ch => {
      totalItems += 3;
      var p = userProgress[cat.id]?.[ch.id] || {};
      if (p.read) { doneItems++; chaptersRead++; }
      if (p.studied) { doneItems++; chaptersStudied++; }
      if (p.quizScore >= 80) { doneItems++; quizzesPassed++; }
    });
  });
  
  var pct = totalItems > 0 ? Math.round((doneItems / totalItems) * 100) : 0;
  document.getElementById('total-progress').textContent = pct + '%';
  document.getElementById('progress-ring-circle').style.strokeDashoffset = 163.36 - (pct / 100) * 163.36;
  document.getElementById('stat-chapters').textContent = chaptersRead;
  document.getElementById('stat-studied').textContent = chaptersStudied;
  document.getElementById('stat-quizzes').textContent = quizzesPassed;
  document.getElementById('stat-notes').textContent = annotations.notes.length + annotations.highlights.length;
  
  // Render guidance section
  renderGuidanceSection();
  
  // Render quick bookmarks
  renderQuickBookmarks();
  
  // Render recent activity
  renderRecentActivity();
  
  // Render categories
  renderDomainsSection();
  renderBooksSection();
  
  // Calculate section progress
  var domainsDone = 0, domainsTotal = 0;
  DOMAINS.forEach(d => d.chapters.forEach(c => {
    domainsTotal += 3;
    var p = userProgress[d.id]?.[c.id] || {};
    if (p.read) domainsDone++;
    if (p.studied) domainsDone++;
    if (p.quizScore >= 80) domainsDone++;
  }));
  document.getElementById('domains-progress').textContent = domainsTotal > 0 ? Math.round((domainsDone / domainsTotal) * 100) + '%' : '0%';
  
  var booksDone = 0, booksTotal = 0;
  BOOKS.forEach(b => {
    if (!b.comingSoon) b.chapters?.forEach(c => {
      booksTotal += 3;
      var p = userProgress[b.id]?.[c.id] || {};
      if (p.read) booksDone++;
      if (p.studied) booksDone++;
      if (p.quizScore >= 80) booksDone++;
    });
  });
  document.getElementById('books-progress').textContent = booksTotal > 0 ? Math.round((booksDone / booksTotal) * 100) + '%' : '0%';
}

function renderGuidanceSection() {
  var html = '';
  
  // Find what to do next
  var nextStep = findNextStep();
  
  if (nextStep.isNew) {
    // New user - show welcome
    html += '<div class="guidance-card"><div class="flex items-center gap-3 mb-3"><div class="text-3xl">üéì</div><div><h3 class="font-bold text-lg">Welcome to Licensing!</h3><p class="text-red-100 text-sm">Start your journey to Foursquare ministry</p></div></div>';
    html += '<p class="text-red-100 mb-4">Begin with the <strong>Heritage</strong> domain to learn about our founder, Aimee Semple McPherson, and the history of The Foursquare Church.</p>';
    html += '<button onclick="openCategory(\'domain\',\'heritage\')" class="w-full bg-white text-red-700 py-3 rounded-xl font-semibold">Start Here ‚Üí</button></div>';
  } else if (nextStep.type === 'continue') {
    // Continue reading
    html += '<div class="next-step-card" onclick="' + nextStep.action + '"><div class="flex items-center gap-3"><div class="text-2xl">' + nextStep.icon + '</div><div class="flex-1"><p class="text-green-100 text-xs uppercase font-medium">Continue Where You Left Off</p><h3 class="font-bold">' + nextStep.title + '</h3><p class="text-green-100 text-sm">' + nextStep.details + '</p></div><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div></div>';
  } else if (nextStep.type === 'next') {
    // Next recommended step
    html += '<div class="next-step-card" onclick="' + nextStep.action + '"><div class="flex items-center gap-3"><div class="text-2xl">' + nextStep.icon + '</div><div class="flex-1"><p class="text-green-100 text-xs uppercase font-medium">Your Next Step</p><h3 class="font-bold">' + nextStep.title + '</h3><p class="text-green-100 text-sm">' + nextStep.details + '</p></div><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div></div>';
  }
  
  document.getElementById('guidance-section').innerHTML = html;
}

function findNextStep() {
  // Check if new user (nothing done)
  var hasAnyProgress = false;
  [...DOMAINS, ...BOOKS].forEach(cat => {
    if (cat.comingSoon) return;
    cat.chapters?.forEach(ch => {
      var p = userProgress[cat.id]?.[ch.id] || {};
      if (p.read || p.studied || p.quizScore > 0) hasAnyProgress = true;
    });
  });
  
  if (!hasAnyProgress) return {isNew: true};
  
  // Check for continue reading
  if (userProgress.lastRead) {
    var lr = userProgress.lastRead;
    var cat = [...DOMAINS, ...BOOKS].find(c => c.id === lr.catId);
    if (cat) {
      var ch = cat.chapters.find(c => c.id === lr.chId);
      if (ch) {
        var p = userProgress[cat.id]?.[ch.id] || {};
        if (!p.read) {
          return {
            type: 'continue', icon: 'üìñ',
            title: ch.num ? 'Chapter ' + ch.num + ': ' + ch.title : ch.title,
            details: 'Page ' + lr.page + ' ‚Ä¢ ' + cat.name,
            action: 'resumeLastReading()'
          };
        }
      }
    }
  }
  
  // Find next incomplete chapter
  var allCats = [...DOMAINS, ...BOOKS];
  for (var i = 0; i < allCats.length; i++) {
    var cat = allCats[i];
    if (cat.comingSoon) continue;
    for (var j = 0; j < (cat.chapters?.length || 0); j++) {
      var ch = cat.chapters[j];
      var p = userProgress[cat.id]?.[ch.id] || {};
      
      if (!p.read) {
        return {
          type: 'next', icon: 'üìñ',
          title: 'Read: ' + (ch.num ? 'Chapter ' + ch.num : ch.title),
          details: cat.name,
          action: "openChapter('" + (DOMAINS.includes(cat) ? 'domain' : 'book') + "','" + cat.id + "','" + ch.id + "')"
        };
      }
      if (!p.studied) {
        return {
          type: 'next', icon: 'üìù',
          title: 'Study: ' + (ch.num ? 'Chapter ' + ch.num : ch.title),
          details: cat.name + ' ‚Ä¢ Complete the study guide',
          action: "openChapter('" + (DOMAINS.includes(cat) ? 'domain' : 'book') + "','" + cat.id + "','" + ch.id + "')"
        };
      }
      if (p.quizScore < 80) {
        return {
          type: 'next', icon: '‚úÖ',
          title: 'Quiz: ' + (ch.num ? 'Chapter ' + ch.num : ch.title),
          details: cat.name + ' ‚Ä¢ Score 80%+ to pass',
          action: "openChapter('" + (DOMAINS.includes(cat) ? 'domain' : 'book') + "','" + cat.id + "','" + ch.id + "')"
        };
      }
    }
  }
  
  return {type: 'next', icon: 'üéâ', title: 'All Complete!', details: 'Review any material', action: 'showNav(\'study\')'};
}

function renderQuickBookmarks() {
  if (annotations.bookmarks.length === 0) {
    document.getElementById('bookmarks-section').innerHTML = '';
    return;
  }
  
  var recent = annotations.bookmarks.slice(0, 3);
  var html = '<h3 class="text-sm font-semibold text-slate-500 uppercase mb-2">üìë Quick Bookmarks</h3>';
  recent.forEach(b => {
    html += '<div class="bookmark-quick" onclick="goToBookmark(\'' + b.chapterId + '\',' + b.page + ')"><div class="flex items-center justify-between"><span class="font-medium text-sm">' + (b.chapterTitle || 'Chapter') + '</span><span class="text-xs text-amber-700">Page ' + b.page + '</span></div></div>';
  });
  document.getElementById('bookmarks-section').innerHTML = html;
}

function goToBookmark(chapterId, page) {
  // Find the chapter
  [...DOMAINS, ...BOOKS].forEach(cat => {
    if (cat.comingSoon) return;
    var ch = cat.chapters?.find(c => c.id === chapterId);
    if (ch) {
      currentCategory = cat;
      currentChapter = ch;
      if (ch.hasFullText && !loadedContent[ch.id]) {
        var s = document.createElement('script');
        s.src = 'chapters/' + ch.id + '.js';
        s.onload = () => {
          var v = 'FOPT_' + ch.id.toUpperCase();
          if (window[v]) { loadedContent[ch.id] = window[v].content; openReader(page); }
        };
        document.head.appendChild(s);
      } else {
        openReader(page);
      }
    }
  });
}

function renderRecentActivity() {
  if (recentActivity.length === 0) {
    document.getElementById('recent-section').innerHTML = '';
    return;
  }
  
  var html = '<h3 class="text-sm font-semibold text-slate-500 uppercase mb-2">üïê Recent Activity</h3>';
  recentActivity.slice(0, 3).forEach(a => {
    var icon = a.type === 'read' ? 'üìñ' : a.type === 'study' ? 'üìù' : a.type === 'quiz' ? '‚úÖ' : 'üìå';
    var timeAgo = getTimeAgo(a.time);
    html += '<div class="recent-activity"><div class="flex items-center justify-between"><span class="font-medium text-sm">' + icon + ' ' + a.title + '</span><span class="text-xs text-slate-400">' + timeAgo + '</span></div><p class="text-xs text-slate-500 mt-1">' + a.details + '</p></div>';
  });
  document.getElementById('recent-section').innerHTML = html;
}

function getTimeAgo(dateStr) {
  var diff = Date.now() - new Date(dateStr).getTime();
  var mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  var hours = Math.floor(mins / 60);
  if (hours < 24) return hours + 'h ago';
  var days = Math.floor(hours / 24);
  return days + 'd ago';
}


// ========== CATEGORY RENDERING ==========
function renderDomainsSection() {
  var html = '';
  DOMAINS.forEach(d => {
    var done = 0;
    d.chapters.forEach(c => {
      var p = userProgress[d.id]?.[c.id] || {};
      if (p.read && p.studied && p.quizScore >= 80) done++;
    });
    html += '<div class="chapter-item" onclick="openCategory(\'domain\',\'' + d.id + '\')"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + d.color + ' flex items-center justify-center text-xl mr-3">' + d.icon + '</div><div class="flex-1"><div class="font-medium">' + d.name + '</div><div class="text-xs text-slate-500">' + d.chapters.length + ' chapter' + (d.chapters.length > 1 ? 's' : '') + '</div></div><div class="text-sm text-slate-500 mr-2">' + done + '/' + d.chapters.length + '</div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>';
  });
  document.getElementById('domains-content').innerHTML = html;
  document.getElementById('domains-content').classList.toggle('expanded', expandedSections.domains);
  document.getElementById('domains-chevron').style.transform = expandedSections.domains ? 'rotate(180deg)' : '';
}

function renderBooksSection() {
  var html = '';
  BOOKS.forEach(b => {
    if (b.comingSoon) {
      html += '<div class="chapter-item opacity-50"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + b.color + ' flex items-center justify-center text-xl mr-3">' + b.icon + '</div><div class="flex-1"><div class="font-medium">' + b.name + '</div><div class="text-xs text-slate-500">' + b.desc + '</div></div><span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded-full">Coming Soon</span></div>';
    } else {
      var done = 0;
      b.chapters.forEach(c => {
        var p = userProgress[b.id]?.[c.id] || {};
        if (p.read && p.studied && p.quizScore >= 80) done++;
      });
      html += '<div class="chapter-item" onclick="openCategory(\'book\',\'' + b.id + '\')"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + b.color + ' flex items-center justify-center text-xl mr-3">' + b.icon + '</div><div class="flex-1"><div class="font-medium">' + b.name + '</div><div class="text-xs text-slate-500">' + b.chapters.length + ' chapters</div></div><div class="text-sm text-slate-500 mr-2">' + done + '/' + b.chapters.length + '</div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>';
    }
  });
  document.getElementById('books-content').innerHTML = html;
  document.getElementById('books-content').classList.toggle('expanded', expandedSections.books);
  document.getElementById('books-chevron').style.transform = expandedSections.books ? 'rotate(180deg)' : '';
}

function openCategory(type, id) {
  var cat = type === 'domain' ? DOMAINS.find(d => d.id === id) : BOOKS.find(b => b.id === id);
  if (!cat || cat.comingSoon) return;
  showScreen('study');
  
  var html = '<div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl bg-gradient-to-br ' + cat.color + ' flex items-center justify-center text-2xl">' + cat.icon + '</div><div><h2 class="font-bold text-lg">' + cat.name + '</h2><p class="text-sm text-slate-500">' + cat.chapters.length + ' chapters</p></div></div>';
  
  cat.chapters.forEach(ch => {
    var p = userProgress[cat.id]?.[ch.id] || {};
    var allDone = p.read && p.studied && p.quizScore >= 80;
    var title = ch.num ? 'Chapter ' + ch.num + ': ' + ch.title : ch.title;
    
    html += '<div class="main-card p-4 mb-3 cursor-pointer" onclick="openChapter(\'' + type + '\',\'' + cat.id + '\',\'' + ch.id + '\')">';
    html += '<div class="flex items-center gap-3">';
    html += allDone ? '<div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">‚úì</div>' : '<div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold">' + (ch.num || '‚Ä¢') + '</div>';
    html += '<div class="flex-1"><div class="font-medium">' + title + '</div>';
    html += '<div class="flex gap-3 mt-1">';
    html += '<span class="text-xs ' + (p.read ? 'text-green-600' : 'text-slate-400') + '">üìñ Read</span>';
    html += '<span class="text-xs ' + (p.studied ? 'text-green-600' : 'text-slate-400') + '">üìù Study</span>';
    html += '<span class="text-xs ' + (p.quizScore >= 80 ? 'text-green-600' : p.quizScore > 0 ? 'text-amber-600' : 'text-slate-400') + '">‚úÖ ' + (p.quizScore > 0 ? p.quizScore + '%' : 'Quiz') + '</span>';
    html += '</div></div>';
    html += '<svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
    html += '</div></div>';
  });
  
  document.getElementById('study-list').innerHTML = html;
}

function renderStudyList() {
  var html = '<h2 class="font-bold text-lg mb-4">All Study Materials</h2>';
  
  html += '<h3 class="font-medium text-slate-500 text-sm uppercase mb-3">üìã Licensing Domains</h3>';
  DOMAINS.forEach(d => {
    var done = 0;
    d.chapters.forEach(c => { var p = userProgress[d.id]?.[c.id] || {}; if (p.read && p.studied && p.quizScore >= 80) done++; });
    html += '<div class="main-card p-4 mb-3 cursor-pointer" onclick="openCategory(\'domain\',\'' + d.id + '\')"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + d.color + ' flex items-center justify-center text-xl">' + d.icon + '</div><div class="flex-1"><div class="font-medium">' + d.name + '</div><div class="text-xs text-slate-500">' + d.chapters.length + ' chapters ‚Ä¢ ' + done + ' complete</div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div></div>';
  });
  
  html += '<h3 class="font-medium text-slate-500 text-sm uppercase mb-3 mt-6">üìö Required Books</h3>';
  BOOKS.forEach(b => {
    if (b.comingSoon) {
      html += '<div class="main-card p-4 mb-3 opacity-50"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + b.color + ' flex items-center justify-center text-xl">' + b.icon + '</div><div class="flex-1"><div class="font-medium">' + b.name + '</div><div class="text-xs text-slate-500">Coming Soon</div></div></div></div>';
    } else {
      var done = 0;
      b.chapters.forEach(c => { var p = userProgress[b.id]?.[c.id] || {}; if (p.read && p.studied && p.quizScore >= 80) done++; });
      html += '<div class="main-card p-4 mb-3 cursor-pointer" onclick="openCategory(\'book\',\'' + b.id + '\')"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-gradient-to-br ' + b.color + ' flex items-center justify-center text-xl">' + b.icon + '</div><div class="flex-1"><div class="font-medium">' + b.name + '</div><div class="text-xs text-slate-500">' + b.chapters.length + ' chapters ‚Ä¢ ' + done + ' complete</div></div><svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div></div>';
    }
  });
  
  document.getElementById('study-list').innerHTML = html;
}


// ========== CHAPTER VIEW ==========
function openChapter(type, catId, chId) {
  var cat = type === 'domain' ? DOMAINS.find(d => d.id === catId) : BOOKS.find(b => b.id === catId);
  currentCategory = cat;
  currentChapter = cat.chapters.find(c => c.id === chId);
  showScreen('chapter');
  
  var title = currentChapter.num ? 'Chapter ' + currentChapter.num + ': ' + currentChapter.title : currentChapter.title;
  document.getElementById('chapter-title').textContent = title;
  document.getElementById('chapter-subtitle').textContent = cat.name;
  switchChapterTab('overview');
}

function backFromChapter() { showNav('home'); }

function switchChapterTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.chapter-tab').forEach(t => t.classList.add('hidden'));
  document.getElementById('chapter-tab-' + tab).classList.remove('hidden');
  
  if (tab === 'overview') renderOverviewTab();
  else if (tab === 'read') renderReadTab();
  else if (tab === 'study') renderStudyTab();
  else if (tab === 'quiz') renderQuizTab();
}

function renderOverviewTab() {
  var ch = currentChapter;
  var p = userProgress[currentCategory.id]?.[ch.id] || {};
  var sg = ch.studyGuide || getDefaultStudyGuide(ch);
  
  var html = '<div class="main-card p-4 mb-4"><h3 class="font-bold text-lg mb-2">üìã Chapter Summary</h3><p class="text-slate-600 leading-relaxed">' + (ch.summary || 'Study this chapter to learn important theological foundations.') + '</p></div>';
  
  // Progress card
  html += '<div class="main-card p-4 mb-4"><h3 class="font-bold mb-3">Your Progress</h3><div class="space-y-3">';
  html += '<div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="text-lg">üìñ</span> Reading</span>' + (p.read ? '<span class="text-green-600 font-medium">‚úì Complete</span>' : '<span class="text-slate-400">Not started</span>') + '</div>';
  html += '<div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="text-lg">üìù</span> Study Guide</span>' + (p.studied ? '<span class="text-green-600 font-medium">‚úì Complete</span>' : '<span class="text-slate-400">Not started</span>') + '</div>';
  html += '<div class="flex items-center justify-between"><span class="flex items-center gap-2"><span class="text-lg">‚úÖ</span> Quiz</span>';
  if (p.quizScore >= 80) html += '<span class="text-green-600 font-medium">‚úì Passed ' + p.quizScore + '%</span>';
  else if (p.quizScore > 0) html += '<span class="text-amber-600">' + p.quizScore + '% (need 80%)</span>';
  else html += '<span class="text-slate-400">Not taken</span>';
  html += '</div></div></div>';
  
  // Learning objectives
  if (sg.objectives && sg.objectives.length > 0) {
    html += '<div class="main-card p-4 mb-4"><h3 class="font-bold mb-3">üéØ Learning Objectives</h3><div class="space-y-2">';
    sg.objectives.forEach(obj => {
      html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5">‚óã</span><span class="text-slate-600 text-sm">' + obj + '</span></div>';
    });
    html += '</div></div>';
  }
  
  // Key terms
  if (sg.keyTerms && sg.keyTerms.length > 0) {
    html += '<div class="main-card p-4 mb-4"><h3 class="font-bold mb-3">üìö Key Terms</h3><div class="space-y-2">';
    sg.keyTerms.forEach(t => {
      if (typeof t === 'object') {
        html += '<div class="pb-2 border-b border-slate-100 last:border-0"><span class="key-term">' + t.term + '</span><span class="text-slate-600 text-sm ml-2">‚Äî ' + t.def + '</span></div>';
      } else {
        html += '<span class="key-term mr-2 mb-2 inline-block">' + t + '</span>';
      }
    });
    html += '</div></div>';
  }
  
  // Key scriptures
  if (sg.keyScriptures && sg.keyScriptures.length > 0) {
    html += '<div class="main-card p-4 mb-4"><h3 class="font-bold mb-3">üìñ Key Scriptures</h3><div class="flex flex-wrap gap-2">';
    sg.keyScriptures.forEach(ref => {
      html += '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">' + ref + '</span>';
    });
    html += '</div></div>';
  }
  
  // Action buttons
  html += '<div class="grid grid-cols-2 gap-3"><button onclick="switchChapterTab(\'read\')" class="py-3 bg-red-600 text-white rounded-xl font-medium">üìñ Read Chapter</button><button onclick="switchChapterTab(\'study\')" class="py-3 border border-red-600 text-red-600 rounded-xl font-medium">üìù Study Guide</button></div>';
  
  document.getElementById('chapter-tab-overview').innerHTML = html;
}

function renderReadTab() {
  var ch = currentChapter;
  var html = '<div id="read-loading" class="text-center py-12"><div class="loading-spinner mx-auto mb-4"></div><p class="text-slate-500">Loading chapter content...</p></div><div id="read-preview" class="hidden"></div>';
  document.getElementById('chapter-tab-read').innerHTML = html;
  
  if (ch.hasFullText) {
    if (loadedContent[ch.id]) {
      showReadPreview(loadedContent[ch.id]);
    } else {
      var s = document.createElement('script');
      s.src = 'chapters/' + ch.id + '.js';
      s.onload = () => {
        var v = 'FOPT_' + ch.id.toUpperCase();
        if (window[v]) { loadedContent[ch.id] = window[v].content; showReadPreview(loadedContent[ch.id]); }
      };
      s.onerror = () => { document.getElementById('read-loading').innerHTML = '<p class="text-red-500">Failed to load chapter content.</p>'; };
      document.head.appendChild(s);
    }
  } else if (ch.reading) {
    showReadPreview(ch.reading);
  } else {
    document.getElementById('read-loading').innerHTML = '<p class="text-slate-500">No reading content available for this chapter.</p>';
  }
}

function showReadPreview(content) {
  loadedContent[currentChapter.id] = content;
  document.getElementById('read-loading').classList.add('hidden');
  document.getElementById('read-preview').classList.remove('hidden');
  
  var preview = content.substring(0, 1500).replace(/<[^>]+>/g, '');
  var p = userProgress[currentCategory.id]?.[currentChapter.id] || {};
  
  var html = '<div class="main-card p-4 mb-4"><div class="text-slate-600 leading-relaxed">' + preview + '...</div></div>';
  html += '<div class="space-y-3">';
  html += '<button onclick="openReader()" class="w-full py-3 bg-red-600 text-white rounded-xl font-medium">üìñ Open Full Reader</button>';
  if (p.lastPage > 1) {
    html += '<button onclick="openReader(' + p.lastPage + ')" class="w-full py-3 border border-red-600 text-red-600 rounded-xl font-medium">üìë Resume from Page ' + p.lastPage + '</button>';
  }
  html += '<button onclick="markRead()" class="w-full py-3 border border-slate-300 rounded-xl text-slate-600">' + (p.read ? '‚úì Marked as Read' : 'Mark as Read (skip reading)') + '</button>';
  html += '</div>';
  
  document.getElementById('read-preview').innerHTML = html;
}

function markRead() {
  userProgress[currentCategory.id][currentChapter.id].read = true;
  addRecentActivity('read', currentChapter.num ? 'Ch. ' + currentChapter.num : currentChapter.title, 'Marked as read');
  saveProgress();
  renderReadTab();
}


// ========== STUDY TAB ==========
function renderStudyTab() {
  var ch = currentChapter;
  var sg = ch.studyGuide || getDefaultStudyGuide(ch);
  
  if (!sg || !sg.sections || sg.sections.length === 0) {
    document.getElementById('chapter-tab-study').innerHTML = '<div class="text-center py-12 text-slate-500"><p>No study guide available for this chapter yet.</p><p class="text-sm mt-2">Complete the reading and take the quiz to continue.</p></div>';
    return;
  }
  
  studyIndex = 0;
  renderStudySection();
}

function renderStudySection() {
  var sg = currentChapter.studyGuide || getDefaultStudyGuide(currentChapter);
  var section = sg.sections[studyIndex];
  
  var html = '<div class="study-container">';
  html += '<div class="flex items-center justify-between mb-4"><span class="text-sm text-slate-500">Section ' + (studyIndex + 1) + ' of ' + sg.sections.length + '</span><div class="h-2 flex-1 bg-slate-200 rounded-full mx-4"><div class="h-full bg-red-500 rounded-full transition-all" style="width:' + ((studyIndex + 1) / sg.sections.length * 100) + '%"></div></div></div>';
  
  html += '<div class="study-section"><h4>' + section.title + '</h4><div class="study-section-content">' + section.content + '</div></div>';
  html += '</div>';
  
  // Fixed navigation at bottom
  html += '<div class="study-nav-fixed">';
  html += '<button onclick="prevStudySection()" class="flex-1 px-6 py-3 border border-slate-300 rounded-xl font-medium ' + (studyIndex === 0 ? 'opacity-30 cursor-not-allowed bg-slate-50' : 'hover:bg-slate-50 bg-white') + '" ' + (studyIndex === 0 ? 'disabled' : '') + '>‚Üê Previous</button>';
  html += '<button onclick="nextStudySection()" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">' + (studyIndex === sg.sections.length - 1 ? 'Complete Study ‚úì' : 'Next ‚Üí') + '</button>';
  html += '</div>';
  
  document.getElementById('chapter-tab-study').innerHTML = html;
}

function prevStudySection() { if (studyIndex > 0) { studyIndex--; renderStudySection(); } }

function nextStudySection() {
  var sg = currentChapter.studyGuide || getDefaultStudyGuide(currentChapter);
  if (studyIndex < sg.sections.length - 1) {
    studyIndex++;
    renderStudySection();
  } else {
    userProgress[currentCategory.id][currentChapter.id].studied = true;
    addRecentActivity('study', currentChapter.num ? 'Ch. ' + currentChapter.num : currentChapter.title, 'Completed study guide');
    saveProgress();
    switchChapterTab('quiz');
  }
}

// ========== QUIZ TAB ==========
function renderQuizTab() {
  var ch = currentChapter;
  var quizzes = ch.quizzes || getDefaultQuizzes(ch);
  
  if (!quizzes || quizzes.length === 0) {
    document.getElementById('chapter-tab-quiz').innerHTML = '<div class="text-center py-12 text-slate-500"><p>No quiz available for this chapter yet.</p></div>';
    return;
  }
  
  // Shuffle and select questions (max 20 per session)
  currentQuizSet = shuffleArray([...quizzes]).slice(0, Math.min(20, quizzes.length));
  quizIndex = 0;
  quizScore = 0;
  selectedQuizAnswer = null;
  renderQuizQuestion();
}

function shuffleArray(arr) {
  for (var i = arr.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function renderQuizQuestion() {
  var q = currentQuizSet[quizIndex];
  var diffClass = q.difficulty === 'easy' ? 'difficulty-easy' : q.difficulty === 'hard' ? 'difficulty-hard' : 'difficulty-medium';
  var diffLabel = q.difficulty === 'easy' ? 'Easy' : q.difficulty === 'hard' ? 'Challenging' : 'Standard';
  
  var html = '<div class="flex items-center justify-between mb-4">';
  html += '<span class="text-sm text-slate-500">Question ' + (quizIndex + 1) + ' of ' + currentQuizSet.length + '</span>';
  html += '<span class="difficulty-badge ' + diffClass + '">' + diffLabel + '</span>';
  html += '</div>';
  
  html += '<div class="main-card p-4 mb-4"><h3 class="font-bold text-lg mb-4">' + q.q + '</h3>';
  html += '<div class="space-y-3" id="quiz-options">';
  
  var labels = ['A', 'B', 'C', 'D'];
  q.options.forEach((opt, i) => {
    html += '<button class="quiz-option w-full p-4 border-2 border-slate-200 rounded-xl text-left flex items-center gap-3" onclick="selectQuizAnswer(' + i + ')" data-idx="' + i + '">';
    html += '<span class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-600">' + labels[i] + '</span>';
    html += '<span class="flex-1">' + opt + '</span>';
    html += '</button>';
  });
  
  html += '</div>';
  html += '<div id="quiz-feedback" class="hidden mt-4 p-4 rounded-xl"></div>';
  html += '</div>';
  
  html += '<button id="quiz-submit-btn" onclick="submitQuizAnswer()" class="w-full py-3 bg-red-600 text-white rounded-xl font-medium disabled:opacity-30 disabled:cursor-not-allowed" disabled>Check Answer</button>';
  html += '<button id="quiz-next-btn" onclick="nextQuizQuestion()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium hidden">Next Question ‚Üí</button>';
  
  document.getElementById('chapter-tab-quiz').innerHTML = html;
}

function selectQuizAnswer(i) {
  selectedQuizAnswer = i;
  document.querySelectorAll('.quiz-option').forEach((b, idx) => b.classList.toggle('selected', idx === i));
  document.getElementById('quiz-submit-btn').disabled = false;
}

function submitQuizAnswer() {
  var q = currentQuizSet[quizIndex];
  var correct = selectedQuizAnswer === q.correct;
  if (correct) quizScore++;
  
  document.querySelectorAll('.quiz-option').forEach(b => {
    var idx = parseInt(b.dataset.idx);
    b.onclick = null;
    b.style.cursor = 'default';
    if (idx === q.correct) b.classList.add('correct');
    else if (idx === selectedQuizAnswer && !correct) b.classList.add('incorrect');
  });
  
  var fb = document.getElementById('quiz-feedback');
  fb.classList.remove('hidden');
  fb.className = 'mt-4 p-4 rounded-xl ' + (correct ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200');
  fb.innerHTML = '<div class="font-bold ' + (correct ? 'text-green-800' : 'text-red-800') + '">' + (correct ? '‚úì Correct!' : '‚úó Incorrect') + '</div><div class="text-sm mt-2 ' + (correct ? 'text-green-700' : 'text-red-700') + '">' + q.explanation + '</div>';
  
  document.getElementById('quiz-submit-btn').classList.add('hidden');
  document.getElementById('quiz-next-btn').classList.remove('hidden');
  document.getElementById('quiz-next-btn').textContent = quizIndex === currentQuizSet.length - 1 ? 'See Results' : 'Next Question ‚Üí';
}

function nextQuizQuestion() {
  if (quizIndex < currentQuizSet.length - 1) {
    quizIndex++;
    selectedQuizAnswer = null;
    renderQuizQuestion();
  } else {
    showQuizResults();
  }
}

function showQuizResults() {
  var total = currentQuizSet.length;
  var pct = Math.round((quizScore / total) * 100);
  var passed = pct >= 80;
  
  var best = userProgress[currentCategory.id][currentChapter.id].quizScore || 0;
  if (pct > best) userProgress[currentCategory.id][currentChapter.id].quizScore = pct;
  addRecentActivity('quiz', currentChapter.num ? 'Ch. ' + currentChapter.num : currentChapter.title, 'Scored ' + pct + '%' + (passed ? ' - Passed!' : ''));
  saveProgress();
  
  var html = '<div class="text-center py-8">';
  html += '<div class="text-6xl mb-4">' + (passed ? 'üéâ' : 'üìö') + '</div>';
  html += '<h2 class="text-2xl font-bold mb-2">' + (passed ? 'Congratulations!' : 'Keep Studying') + '</h2>';
  html += '<p class="text-slate-600 mb-6">' + (passed ? 'You passed with ' + pct + '%!' : 'You need 80% to pass. You scored ' + pct + '%.') + '</p>';
  
  html += '<div class="flex justify-center gap-4 mb-6">';
  html += '<div class="bg-green-50 rounded-xl p-4 min-w-[80px]"><div class="text-3xl font-bold text-green-600">' + quizScore + '</div><div class="text-sm text-green-700">Correct</div></div>';
  html += '<div class="bg-red-50 rounded-xl p-4 min-w-[80px]"><div class="text-3xl font-bold text-red-600">' + (total - quizScore) + '</div><div class="text-sm text-red-700">Incorrect</div></div>';
  html += '</div>';
  
  if (passed) {
    html += '<p class="text-sm text-slate-500 mb-4">Best score: ' + Math.max(pct, best) + '%</p>';
  }
  
  html += '<div class="flex gap-3">';
  html += '<button onclick="renderQuizTab()" class="flex-1 py-3 border border-slate-300 rounded-xl font-medium hover:bg-slate-50">' + (passed ? 'Retake Quiz' : 'Try Again') + '</button>';
  html += '<button onclick="switchChapterTab(\'overview\')" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">Done</button>';
  html += '</div></div>';
  
  document.getElementById('chapter-tab-quiz').innerHTML = html;
}


// ========== READER ==========
function openReader(startPage) {
  var content = loadedContent[currentChapter.id] || currentChapter.reading || '';
  if (!content) return;
  
  paginateContent(content);
  currentPage = startPage || userProgress[currentCategory.id]?.[currentChapter.id]?.lastPage || 1;
  if (currentPage > contentPages.length) currentPage = 1;
  
  showScreen('reader');
  applyReaderSettings();
  renderReaderPage();
  setupTextSelection();
  loadVoices();
  
  userProgress.lastRead = {catId: currentCategory.id, chId: currentChapter.id, page: currentPage};
  saveProgress();
}

function closeReader() {
  stopTTS();
  userProgress[currentCategory.id][currentChapter.id].lastPage = currentPage;
  
  // Mark as read if at last page
  if (currentPage >= contentPages.length - 1) {
    userProgress[currentCategory.id][currentChapter.id].read = true;
    addRecentActivity('read', currentChapter.num ? 'Ch. ' + currentChapter.num : currentChapter.title, 'Completed reading');
  }
  saveProgress();
  showScreen('chapter');
  renderReadTab();
}

function paginateContent(content) {
  contentPages = [];
  var charsPerPage = 2500;
  
  // Clean up the content
  var text = content.replace(/\n/g, ' ').replace(/\t/g, ' ');
  
  // Split into paragraphs
  var paragraphs = text.split(/(<\/p>|<\/h[123]>|<\/div>|<\/li>|<\/ul>|<\/ol>)/gi);
  var page = '';
  
  for (var i = 0; i < paragraphs.length; i++) {
    var para = paragraphs[i];
    if (!para || para.length < 3) continue;
    
    if (page.length + para.length > charsPerPage && page.length > 500) {
      contentPages.push(page);
      page = para;
    } else {
      page += para;
    }
  }
  if (page.trim()) contentPages.push(page);
  if (contentPages.length === 0) contentPages = ['No content available'];
}

function renderReaderPage() {
  var pageContent = contentPages[currentPage - 1] || '';
  
  // Apply highlights
  annotations.highlights.forEach(h => {
    if (h.chapterId === currentChapter.id && h.page === currentPage) {
      var re = new RegExp('(' + escapeRegex(h.text.substring(0, 50)) + ')', 'gi');
      pageContent = pageContent.replace(re, '<span class="highlight-' + h.color + '">$1</span>');
    }
  });
  
  document.getElementById('reader-page-content').innerHTML = pageContent;
  document.getElementById('reader-title-bar').textContent = currentChapter.num ? 'Chapter ' + currentChapter.num : currentChapter.title;
  document.getElementById('reader-page-indicator').textContent = 'Page ' + currentPage + ' of ' + contentPages.length;
  document.getElementById('page-input').value = currentPage;
  document.getElementById('page-input').max = contentPages.length;
  document.getElementById('total-pages').textContent = contentPages.length;
  document.getElementById('reading-progress-bar').style.width = (currentPage / contentPages.length * 100) + '%';
  document.getElementById('btn-prev').disabled = currentPage <= 1;
  document.getElementById('btn-next').disabled = currentPage >= contentPages.length;
  
  // Update bookmark button
  var isBookmarked = annotations.bookmarks.some(b => b.chapterId === currentChapter.id && b.page === currentPage);
  document.getElementById('btn-bookmark').innerHTML = isBookmarked ? '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="#dc2626" stroke="#dc2626" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>';
  
  // Save position
  userProgress[currentCategory.id][currentChapter.id].lastPage = currentPage;
  userProgress.lastRead = {catId: currentCategory.id, chId: currentChapter.id, page: currentPage};
}

function escapeRegex(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

function prevPage() { if (currentPage > 1) { currentPage--; renderReaderPage(); saveProgress(); } }
function nextPage() { if (currentPage < contentPages.length) { currentPage++; renderReaderPage(); saveProgress(); } }

document.getElementById('page-input').addEventListener('change', function() {
  var p = parseInt(this.value);
  if (p >= 1 && p <= contentPages.length) { currentPage = p; renderReaderPage(); saveProgress(); }
});

function resumeLastReading() {
  var lr = userProgress.lastRead;
  if (!lr) return;
  var cat = [...DOMAINS, ...BOOKS].find(c => c.id === lr.catId);
  if (!cat) return;
  var ch = cat.chapters.find(c => c.id === lr.chId);
  if (!ch) return;
  
  currentCategory = cat;
  currentChapter = ch;
  
  if (ch.hasFullText && !loadedContent[ch.id]) {
    var s = document.createElement('script');
    s.src = 'chapters/' + ch.id + '.js';
    s.onload = () => {
      var v = 'FOPT_' + ch.id.toUpperCase();
      if (window[v]) { loadedContent[ch.id] = window[v].content; openReader(lr.page); }
    };
    document.head.appendChild(s);
  } else {
    openReader(lr.page);
  }
}

// ========== READER SETTINGS ==========
function toggleReaderSettings() {
  document.getElementById('reader-settings-panel').classList.toggle('hidden');
}

function setTheme(t) {
  readerSettings.theme = t;
  applyReaderSettings();
  localStorage.setItem('readerSettings', JSON.stringify(readerSettings));
}

function setFont(f) {
  readerSettings.font = f;
  applyReaderSettings();
  localStorage.setItem('readerSettings', JSON.stringify(readerSettings));
}

function setFontSize(s) {
  readerSettings.fontSize = parseInt(s);
  document.getElementById('size-display').textContent = s + 'px';
  applyReaderSettings();
  localStorage.setItem('readerSettings', JSON.stringify(readerSettings));
}

function applyReaderSettings() {
  var rc = document.getElementById('reader-container');
  rc.className = 'reader-container theme-' + readerSettings.theme + ' font-' + readerSettings.font;
  document.getElementById('reader-page-content').style.fontSize = readerSettings.fontSize + 'px';
  document.getElementById('font-size-slider').value = readerSettings.fontSize;
  document.getElementById('size-display').textContent = readerSettings.fontSize + 'px';
  
  var header = document.getElementById('reader-header');
  var footer = document.getElementById('reader-footer');
  if (readerSettings.theme === 'dark') {
    header.className = 'fixed top-0 left-0 right-0 bg-[#1a1a1a]/95 backdrop-blur border-b border-slate-700 z-40 px-4 py-3 flex items-center justify-between';
    footer.className = 'fixed bottom-0 left-0 right-0 bg-[#1a1a1a]/95 backdrop-blur border-t border-slate-700 z-40 px-4 py-3';
  } else if (readerSettings.theme === 'sepia') {
    header.className = 'fixed top-0 left-0 right-0 bg-[#f4ecd8]/95 backdrop-blur border-b border-amber-200 z-40 px-4 py-3 flex items-center justify-between';
    footer.className = 'fixed bottom-0 left-0 right-0 bg-[#f4ecd8]/95 backdrop-blur border-t border-amber-200 z-40 px-4 py-3';
  } else {
    header.className = 'fixed top-0 left-0 right-0 bg-white/95 backdrop-blur border-b z-40 px-4 py-3 flex items-center justify-between';
    footer.className = 'fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t z-40 px-4 py-3';
  }
}

function setVoice(v) {
  readerSettings.voice = v;
  localStorage.setItem('readerSettings', JSON.stringify(readerSettings));
}


// ========== TEXT-TO-SPEECH ==========
function loadVoices() {
  setTimeout(() => {
    var voices = speechSynthesis.getVoices();
    var select = document.getElementById('reader-voice-select');
    var profileSelect = document.getElementById('voice-select');
    
    select.innerHTML = '<option value="">Default Voice</option>';
    if (profileSelect) profileSelect.innerHTML = '<option value="">Default Voice</option>';
    
    voices.filter(v => v.lang.startsWith('en')).forEach(v => {
      var opt = '<option value="' + v.name + '">' + v.name + '</option>';
      select.innerHTML += opt;
      if (profileSelect) profileSelect.innerHTML += opt;
    });
    
    if (readerSettings.voice) {
      select.value = readerSettings.voice;
      if (profileSelect) profileSelect.value = readerSettings.voice;
    }
  }, 100);
}

function toggleTTS() {
  if (ttsPlaying) stopTTS();
  else startTTS();
}

function startTTS() {
  var text = document.getElementById('reader-page-content').innerText;
  if (!text) return;
  
  ttsUtterance = new SpeechSynthesisUtterance(text);
  ttsUtterance.rate = parseFloat(document.getElementById('tts-speed').value) || 1;
  
  if (readerSettings.voice) {
    var voices = speechSynthesis.getVoices();
    var v = voices.find(voice => voice.name === readerSettings.voice);
    if (v) ttsUtterance.voice = v;
  }
  
  ttsUtterance.onend = () => {
    if (ttsPlaying && currentPage < contentPages.length) {
      currentPage++;
      renderReaderPage();
      saveProgress();
      setTimeout(startTTS, 300);
    } else {
      stopTTS();
    }
  };
  
  speechSynthesis.speak(ttsUtterance);
  ttsPlaying = true;
  document.getElementById('tts-play-icon').classList.add('hidden');
  document.getElementById('tts-pause-icon').classList.remove('hidden');
}

function stopTTS() {
  speechSynthesis.cancel();
  ttsPlaying = false;
  document.getElementById('tts-play-icon').classList.remove('hidden');
  document.getElementById('tts-pause-icon').classList.add('hidden');
}

function ttsRewind() {
  var wasPlaying = ttsPlaying;
  stopTTS();
  if (currentPage > 1) { currentPage--; renderReaderPage(); saveProgress(); }
  if (wasPlaying) setTimeout(startTTS, 200);
}

function ttsForward() {
  var wasPlaying = ttsPlaying;
  stopTTS();
  if (currentPage < contentPages.length) { currentPage++; renderReaderPage(); saveProgress(); }
  if (wasPlaying) setTimeout(startTTS, 200);
}

function updateTTSSpeed() {
  if (ttsPlaying) {
    stopTTS();
    startTTS();
  }
}

// ========== ANNOTATIONS ==========
function setupTextSelection() {
  document.getElementById('reader-page-content').addEventListener('mouseup', handleSelection);
  document.getElementById('reader-page-content').addEventListener('touchend', handleSelection);
}

function handleSelection(e) {
  var sel = window.getSelection();
  var text = sel.toString().trim();
  
  if (text.length > 5) {
    pendingSelection = text;
    var popup = document.getElementById('selection-popup');
    popup.classList.add('show');
    
    var range = sel.getRangeAt(0);
    var rect = range.getBoundingClientRect();
    popup.style.top = (rect.top + window.scrollY - 50) + 'px';
    popup.style.left = Math.max(10, Math.min(rect.left + rect.width/2 - 70, window.innerWidth - 160)) + 'px';
  } else {
    document.getElementById('selection-popup').classList.remove('show');
  }
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.selection-popup') && !e.target.closest('#reader-page-content')) {
    document.getElementById('selection-popup')?.classList.remove('show');
  }
});

function addHighlight(color) {
  if (!pendingSelection) return;
  
  annotations.highlights.push({
    id: Date.now(),
    chapterId: currentChapter.id,
    chapterTitle: currentChapter.num ? 'Chapter ' + currentChapter.num : currentChapter.title,
    page: currentPage,
    text: pendingSelection,
    color: color,
    created: new Date().toISOString()
  });
  
  document.getElementById('selection-popup').classList.remove('show');
  window.getSelection().removeAllRanges();
  renderReaderPage();
  saveProgress();
}

function addNoteToSelection() {
  if (!pendingSelection) return;
  document.getElementById('note-modal-quote').textContent = '"' + pendingSelection.substring(0, 150) + (pendingSelection.length > 150 ? '...' : '') + '"';
  document.getElementById('note-modal-text').value = '';
  document.getElementById('note-modal').classList.remove('hidden');
  document.getElementById('selection-popup').classList.remove('show');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
}

function saveNote() {
  var text = document.getElementById('note-modal-text').value.trim();
  if (!text) return;
  
  annotations.notes.push({
    id: Date.now(),
    chapterId: currentChapter.id,
    chapterTitle: currentChapter.num ? 'Chapter ' + currentChapter.num : currentChapter.title,
    page: currentPage,
    quote: pendingSelection,
    note: text,
    created: new Date().toISOString()
  });
  
  closeNoteModal();
  window.getSelection().removeAllRanges();
  pendingSelection = '';
  saveProgress();
}

function toggleBookmark() {
  var idx = annotations.bookmarks.findIndex(b => b.chapterId === currentChapter.id && b.page === currentPage);
  
  if (idx >= 0) {
    annotations.bookmarks.splice(idx, 1);
  } else {
    annotations.bookmarks.push({
      id: Date.now(),
      chapterId: currentChapter.id,
      chapterTitle: currentChapter.num ? 'Chapter ' + currentChapter.num : currentChapter.title,
      page: currentPage,
      created: new Date().toISOString()
    });
  }
  
  renderReaderPage();
  saveProgress();
}


// ========== NOTES SCREEN ==========
function filterNotes(filter) {
  document.querySelectorAll('.notes-filter').forEach(b => {
    b.classList.toggle('bg-red-600', b.textContent.toLowerCase().includes(filter));
    b.classList.toggle('text-white', b.textContent.toLowerCase().includes(filter));
    b.classList.toggle('bg-slate-100', !b.textContent.toLowerCase().includes(filter));
  });
  
  var items = [];
  
  if (filter === 'all' || filter === 'notes') {
    annotations.notes.forEach(n => items.push({...n, type: 'note'}));
  }
  if (filter === 'all' || filter === 'highlights') {
    annotations.highlights.forEach(h => items.push({...h, type: 'highlight'}));
  }
  if (filter === 'all' || filter === 'bookmarks') {
    annotations.bookmarks.forEach(b => items.push({...b, type: 'bookmark'}));
  }
  
  items.sort((a, b) => new Date(b.created) - new Date(a.created));
  
  if (items.length === 0) {
    document.getElementById('notes-list').innerHTML = '<div class="text-center py-12 text-slate-500"><div class="text-4xl mb-4">üìù</div><p>No ' + filter + ' yet</p><p class="text-sm mt-2">Highlight text or add notes while reading</p></div>';
    return;
  }
  
  var html = '';
  items.forEach(item => {
    html += '<div class="note-card" style="border-left-color:' + (item.type === 'highlight' ? getHighlightColor(item.color) : item.type === 'bookmark' ? '#eab308' : '#3b82f6') + '">';
    html += '<div class="flex items-start justify-between mb-2">';
    html += '<div class="flex items-center gap-2"><span class="text-sm font-medium">' + (item.chapterTitle || 'Chapter') + '</span><span class="text-xs text-slate-400">Page ' + item.page + '</span></div>';
    html += '<button onclick="deleteAnnotation(\'' + item.type + '\',' + item.id + ')" class="text-slate-400 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>';
    html += '</div>';
    
    if (item.type === 'note') {
      html += '<div class="text-xs text-slate-500 italic mb-1">"' + (item.quote || '').substring(0, 80) + '..."</div>';
      html += '<div class="text-sm text-slate-700">' + item.note + '</div>';
    } else if (item.type === 'highlight') {
      html += '<div class="text-sm"><span class="highlight-' + item.color + ' px-1">' + item.text.substring(0, 150) + (item.text.length > 150 ? '...' : '') + '</span></div>';
    } else {
      html += '<div class="text-sm text-slate-600 flex items-center gap-2"><span class="text-yellow-500">üîñ</span> Bookmarked</div>';
    }
    
    html += '<div class="text-xs text-slate-400 mt-2">' + new Date(item.created).toLocaleDateString() + '</div>';
    html += '</div>';
  });
  
  document.getElementById('notes-list').innerHTML = html;
}

function getHighlightColor(color) {
  var colors = {yellow: '#facc15', green: '#4ade80', blue: '#60a5fa', pink: '#f472b6'};
  return colors[color] || '#facc15';
}

function deleteAnnotation(type, id) {
  if (!confirm('Delete this ' + type + '?')) return;
  
  if (type === 'note') annotations.notes = annotations.notes.filter(n => n.id !== id);
  else if (type === 'highlight') annotations.highlights = annotations.highlights.filter(h => h.id !== id);
  else if (type === 'bookmark') annotations.bookmarks = annotations.bookmarks.filter(b => b.id !== id);
  
  saveProgress();
  filterNotes(document.querySelector('.notes-filter.bg-red-600')?.textContent.toLowerCase() || 'all');
}

// ========== PROFILE SCREEN ==========
function renderProfile() {
  var name = currentUser?.user_metadata?.name || currentUser?.email?.split('@')[0] || 'Student';
  document.getElementById('profile-name').textContent = name;
  document.getElementById('profile-email').textContent = currentUser?.email || '';
  document.getElementById('profile-avatar').textContent = name.charAt(0).toUpperCase();
  
  // Calculate stats
  var chaptersRead = 0, chaptersStudied = 0, quizzesPassed = 0;
  [...DOMAINS, ...BOOKS].forEach(cat => {
    if (cat.comingSoon) return;
    cat.chapters?.forEach(ch => {
      var p = userProgress[cat.id]?.[ch.id] || {};
      if (p.read) chaptersRead++;
      if (p.studied) chaptersStudied++;
      if (p.quizScore >= 80) quizzesPassed++;
    });
  });
  
  document.getElementById('profile-chapters').textContent = chaptersRead;
  document.getElementById('profile-studied').textContent = chaptersStudied;
  document.getElementById('profile-quizzes').textContent = quizzesPassed;
  document.getElementById('profile-notes').textContent = annotations.notes.length + annotations.highlights.length;
  document.getElementById('profile-bookmarks').textContent = annotations.bookmarks.length;
  
  // Domain progress
  var domainsDone = 0, domainsTotal = 0;
  DOMAINS.forEach(d => d.chapters.forEach(c => {
    domainsTotal += 3;
    var p = userProgress[d.id]?.[c.id] || {};
    if (p.read) domainsDone++;
    if (p.studied) domainsDone++;
    if (p.quizScore >= 80) domainsDone++;
  }));
  var domainPct = domainsTotal > 0 ? Math.round((domainsDone / domainsTotal) * 100) : 0;
  document.getElementById('profile-domains-pct').textContent = domainPct + '%';
  document.getElementById('profile-domains-bar').style.width = domainPct + '%';
  
  // Books progress
  var booksDone = 0, booksTotal = 0;
  BOOKS.forEach(b => {
    if (!b.comingSoon) b.chapters?.forEach(c => {
      booksTotal += 3;
      var p = userProgress[b.id]?.[c.id] || {};
      if (p.read) booksDone++;
      if (p.studied) booksDone++;
      if (p.quizScore >= 80) booksDone++;
    });
  });
  var booksPct = booksTotal > 0 ? Math.round((booksDone / booksTotal) * 100) : 0;
  document.getElementById('profile-books-pct').textContent = booksPct + '%';
  document.getElementById('profile-books-bar').style.width = booksPct + '%';
  
  loadVoices();
}

function saveVoicePref() {
  var v = document.getElementById('voice-select').value;
  readerSettings.voice = v;
  localStorage.setItem('readerSettings', JSON.stringify(readerSettings));
}

// ========== EVENT LISTENERS ==========
document.getElementById('btn-login').onclick = handleLogin;
document.getElementById('btn-register').onclick = handleRegister;

document.getElementById('login-email').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
document.getElementById('login-password').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });

// Initialize voices
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
</script>
<!-- closing divs fixed -->
</body>
</html>
